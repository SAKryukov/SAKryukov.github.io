<!DOCTYPE html>
<!-- saved from url=(0090)https://www.codeproject.com/Articles/1170503/The-Impossibly-Fast-Cplusplus-Delegates-Fixed -->
<html lang="en" data-lt-installed="true"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

	
	<link rel="preconnect" href="https://www.google-analytics.com/">

	<link rel="preconnect" href="https://www.codeproject.com/">


	<link rel="preload" href="./Resources/logo250x135.gif" as="image">


	<link rel="preload" href="https://www.codeproject.com/App_Themes/CodeProject/Img/logo135-bg.gif" as="image">
	<link rel="preload" href="./Resources/jquery-3.4.1.min.js.download" as="script" type="text/javascript">


	<title>The Impossibly Fast C++ Delegates, Fixed- CodeProject</title> 
    
	<link type="text/css" rel="stylesheet" href="./Resources/Article.min.css">


    <script type="text/javascript" async="" src="./Resources/analytics.js.download"></script><script type="text/javascript" src="./Resources/jquery-3.4.1.min.js.download" defer=""></script>
<script type="text/javascript" src="./Resources/article.min.js.download" defer=""></script>

	
<meta http-equiv="content-language" content="en-US">

<meta name="Description" content="Derived work based on the article by Sergey Ryazanov The Impossibly Fast C++ Delegates: this good solution is fixed and further developed using C++11.">
<meta name="Keywords" content="C++, delegates, VS2013">
<meta name="Author" content="Sergey Alexandrovich Kryukov">
<meta name="Rating" content="General">
<meta name="Revisit-After" content="1 days">
<meta name="application-name" content="CodeProject">
<meta name="google-translate-customization" content="d908bb7ce7aff658-4c2f3a504525c916-g629383f736781a8a-13">



<link rel="dns-prefetch" href="https://ajax.googleapis.com/"> 
<link rel="canonical" href="https://www.codeproject.com/Articles/1170503/The-Impossibly-Fast-Cplusplus-Delegates-Fixed">
<meta name="twitter:card" content="summary">
<meta name="twitter:site" content="@CodeProject">
<meta name="og:site_name" content="CodeProject">
<meta name="twitter:creator" content="@CodeProject">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2/13/2017 3:51:00 PM">
<meta property="article:modified_time" content="3/11/2017 11:34:00 PM">
<meta name="twitter:label1" content="Written by">
<meta name="twitter:data1" content="Sergey Alexandrovich Kryukov">
<meta name="twitter:label2" content="Reading time">
<meta name="twitter:data2" content="11 min read">
<meta property="og:url" content="https://www.codeproject.com/Articles/1170503/The-Impossibly-Fast-Cplusplus-Delegates-Fixed">
<meta property="og:title" content="The Impossibly Fast C++ Delegates, Fixed">
<meta property="og:description" content="Derived work based on the article by Sergey Ryazanov The Impossibly Fast C++ Delegates: this good solution is fixed and further developed using C++11.">


<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="apple-touch-icon" sizes="144x144" href="https://www.codeproject.com/favicon/apple-touch-icon.png"> 
<link rel="icon" type="image/png" sizes="32x32" href="https://www.codeproject.com/favicon/favicon-32x32.png"> 
<link rel="icon" type="image/png" sizes="16x16" href="https://www.codeproject.com/favicon/favicon-16x16.png"> 
<link rel="manifest" href="https://www.codeproject.com/favicon/manifest.json"> 
<link rel="mask-icon" href="https://www.codeproject.com/favicon/safari-pinned-tab.svg" color="#ff9900">
	<script type="application/ld+json">{
  "@context": "http://schema.org",
  "@type": "TechArticle",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://www.codeproject.com/Articles/1170503/The-Impossibly-Fast-Cplusplus-Delegates-Fixed"
   },
  "name": "The Impossibly Fast C++ Delegates, Fixed",
  "headline": "The Impossibly Fast C++ Delegates, Fixed",
  "url": "https://www.codeproject.com/Articles/1170503/The-Impossibly-Fast-Cplusplus-Delegates-Fixed",
  "discussionUrl": "#_comments",
  "isFamilyFriendly": "true",
  "image": "https://www.codeproject.com/App_Themes/CodeProject/Img/Article100.png",
  "keywords": "C++,delegates,VS2013",
  "commentCount": "0",
  "editor" : {
    "@type" : "Person",
    "name" : "Editor",
    "url" : "https://www.codeproject.com/script/Membership/View.aspx?mid=2291164"
  },
  "license": "http://www.opensource.org/licenses/mit-license.php",
  "publisher" : {
    "@type" : "Organization",
    "name" : "CodeProject"
  },
  "description": "Derived work based on the article by Sergey Ryazanov The Impossibly Fast C++ Delegates: this good solution is fixed and further developed using C++11.",
  "articleSection": "C++",
  "author" : [{
      "@type" : "Person",
      "name" : "Sergey Alexandrovich Kryukov",
      "url" : "https://www.codeproject.com/script/Membership/View.aspx?mid=2291164"
    }],
  "datePublished": "2017-02-13",
  "dateCreated": "2017-02-13",
  "dateModified": "2017-03-11"
,
  "contentRating" : {
    "@type" : "Rating",
    "ratingValue" : 5.00,
    "bestRating" : 5,
    "worstRating" : 1
  }
}</script>

<script type="application/ld+json">{
  "@context": "http://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [{
    "@type": "ListItem",
    "position": 1,
    "item" : {
      "@id" : "/script/Content/Tag.aspx?tags=Languages",
      "name" : "Languages"
    }
  },{
    "@type": "ListItem",
    "position": 2,
    "item" : {
      "@id" : "/script/Content/Tag.aspx?tags=Cplusplus",
      "name" : "C++"
    }
  }]
}</script>

<script type="text/javascript">
function defrm () { /* thanks twitter */
    document.write = '';
    window.top.location = window.self.location;
    setTimeout(function() { document.body.innerHTML = ''; }, 0);
    window.self.onload = function(evt) { document.body.innerHTML = ''; };
}

if (window.top !== window.self) {
    try {
        if (window.top.location.host) { /* will throw for all except chrome */ }
        else { defrm(); /* chrome */ }
    } catch (ex) { defrm(); /* everyone else */ }
}

// Specific case where a site is screwing with us.
if (typeof(DemoUrl) !== 'undefined') {
    document.write(unescape('%3Cme') + 'ta http' + '-equiv="re' + 'fresh con' +
                           'tent="1;url=' + DemoUrl + unescape('"%3CE'));
}
</script>
	





    <script async="" type="text/javascript" src="./Resources/js"></script>
    <script type="text/javascript">
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'UA-1735123-1' , {'user_id': '42a7d533-9829-4f88-8fc6-84dc936250c9'});
    </script>

<style type="text/css"></style></head>	

<body class="chrome chrome120" data-new-gr-c-s-check-loaded="14.1215.0" data-gr-ext-installed="">



<a class="access-link" href="#Main"><img alt="Click here to Skip to main content" src="./Resources/t.gif"></a>




<div class="page-background">

	
	

	

	
    <div id="ctl00_STM" class="site-top-menu fixed narrow">
        <div class="main-content">
            

<div class="container memberbar clearfix flex-container flex-extend">

	<div id="ctl00_MemberBar_GenInfo" class="flex-item align-left">65,938 articles</div>
	
	<div id="ctl00_MemberBar_ChangeNotice" class="flex-item align-left">CodeProject
	is changing. <a href="https://www.codeproject.com/info/Changes.aspx">Read more</a>.</div>

	<div class="flex-item">
		
	</div>

	<div class="flex-item align-right">

		

		

		
	</div>
</div>
        </div>
    </div>

	
    <div id="ctl00_SH" class="site-header fixed narrow">
        <div class="main-content">
            <div class="logo"><a href="https://www.codeproject.com/"><img id="ctl00_Logo" tabindex="1" title="CodeProject" src="./Resources/logo250x135.gif" alt="Home" style="height:135px;width:250px;border-width:0px;"></a></div>
            <div class="promo"></div>
        </div>
    </div>

	
			
	

	<div id="A" class="container-content-wrap fixed narrow"> 

	<div class="container-content">

        
		<div class="clearfix">
			<div class="container-breadcrumb float-left ">
				<div><a rel="nofollow" href="https://www.codeproject.com/script/Content/SiteMap.aspx">Articles</a> / <a rel="nofollow" href="https://www.codeproject.com/script/Content/Tag.aspx?tags=Languages">Languages</a> / <a rel="nofollow" href="https://www.codeproject.com/script/Content/Tag.aspx?tags=Cplusplus">C++</a></div>
			</div>

            <div class="float-left">
				
			</div>

			<div class="edit-links float-right">
				



 
&nbsp;










			</div>

			<div class="article-nav float-right">
				


<div style="display:inline-block;position:relative;top:-6px;margin-right:20px">
    
</div>



 

<a id="ctl00_ActionLinks_PrintMd" data-tooltip="Print" data-enabletooltip="true" data-width="auto" href="https://www.codeproject.com/Articles/1170503/The-Impossibly-Fast-Cplusplus-Delegates-Fixed?display=Print" class="tooltip" title="">
   <img src="./Resources/print48.png" width="24" height="24" style="border:0">
<div class="speech-bubble-container-up" style="width:auto">  <div class="speech-bubble-up" style="text-align:center"> Print</div>  <div class="speech-bubble-pointer-up">    <div class="speech-bubble-pointer-up-inner"></div>  </div></div></a>



<span id="ctl00_ActionLinks_R">
    
    
</span>
			</div>
		</div>

        
		<div class="extended article-container-parts">

			
		    
            

			
			<div id="AT" class="article-container  fixed narrow" style="max-width:inherit;"> 

				<div class="article">

					<form name="aspnetForm" method="post" action="https://www.codeproject.com/Articles/1170503/View.aspx" id="aspnetForm" style="margin:0;padding:0">
<div>
<input type="hidden" name="__VIEWSTATE" id="__VIEWSTATE" value="M/w23Csms/ZEioa+cmajtzAJN5x5yoAdERekbFCMst725mzfE+hnpl3ds1p2Cp7XvaQw+fkZ6GICikDzB8SE3WFcjdmARfV9J/DvxqaCkL0QGXDWsVRTFhX6hM0IpgIcx6+BwbMYoxC6eGgW1Ttejn68Go1bNxCFhnRSAMW2+3kLREZoIKLTBMAPLuAGBb1uLmm7dQeYznqH6Pq8+gWFkxpvshr/kGySr8dYBrpFi5wr7gvDtG3aUd8+x/2VqA014wIed8ruchF/84cRgor+8CaPYdY5BhF2B5YMnEQaCmIDQ8uralTRk10/KanewMz32rpxfcdkQZkA9tui0Eg3Mtg7ZBwDGo4vkDrGTlV/1bN3YAB2hyxv8NvFIBqi5+KelYF5QCWPYZL4jrLcSQ5GupAz0urNLML1fg1cOL2hqWmfQ7AHK1c559Yfdj2OT4FPl/EZk1BOzx6AL/UZ0ybl8Xjy/K02PQDO6Vv9bjFNC2Em+50iBr+l+dadkYP4PYhNp4Mp1kvwcKKV22DM3QgavvpF/p67GXiT3zoZiToee45IYE0IJAcdFokLUnT4f3IkTDEryue6BOcy8vNmYgjUPbvqEMa2cgei8UtDH/eX61Up0YnYZqtsgC473c3EQQCh5WX7QIWCF5T3aJQA9kszqw9ENXCvN/U8AmFNLe3UVJ/gI7GjgkUMQx45PRvPLk4RyGubBqQ8KpBxTY0ziowLSJkHldcQ7PMNAJdH6YDdXO4D1kOkUeRN32WQTspj4bgLtQsF9V/1fl4TUrxNWABUtNNwODfUZ5RrtzvHYMVw0gKtWlQDT0Ewefnt365iYQu2D7d/QJw6NOBOWLcxKmBHtBu58Wr5iLCYCST7EbAW6L7Wx1piIzIfjeBoZEzJogClHzzrKhazc27f9gpvKbSCf9nDeFo2SVAacecAxlUlzuf1RMDKjWqyjLqSbXV6MP87H25zlQ/iry2MKIY+TlN+TjHMkI45hx8t0bGBJ3KVUK+38smHr8vt+y4IOdd4vt4pbr8NRSah4pWZlkTK1Cwlsmbe9k7MOd3QFHbUz03d6FnkVcHFmleHKMo824+9Tcq2XKD9+2v+ovjmVaxKhBPYp08ANtiag5tIktJ4pAYu03vTDNWbOWFCXDgE5hiOAgPPro1BALuxENWp0SeQ8GJoQLfidyOk+PuFC3FVQ9DOhK7b9NdfMWuRQfNDqz7oA89Ds7iOxfm1nTk6IdvbTW9mXtr4s2xG0miABwBIl223afdBLtbPsWLcirGvyZ9aGo7oIkeJIuuc1ZC53tWJxVXAsfTrx2uJWQ9kpPngiFaeuA+9Nok8F+pWzMY4hW5ELFbUmw7TA0EjMfrfLVsYzwIl062iTIGkGP6bf39qPQy0hwJ7Hwo5s8QdWsQw/3mMO603v+spUez5zAH5zOkSqHt7ybC2iPL6bQJnFOh5N0NVVQqR/AVpO/UJfNK+waacxWzGeHtgv+mCEhQQs4cW8L/SxNxFnJqgUENBz4hN1Z9twjVWAwdaTBBj8li8XOWljd6vV5mM7FySKeGM1SXZOgAEF4rytdlnMdW4NLYJH+bH1CObvghVpABBKZYlrRJAquCBwzTiHKzV1pADAPP+rNHd4AQdAVe6YsvELj2HnNMpTV51YUijAVdzpUGF68/H+IRFnVwmFtSVlaEu8mxx95FHxzH2Z+TiZBJsBv/SPXzYHKzQyY6jZGkqlEOewaatcOlGmwoj/ApdvLYdP6HQfdBcuswnpflUAnJN6vQRPs46rH3+EBVLEO17P1e7kgzVvUMmwpkcG8QcWTB1y1U9kK1RZsoRNP140UFMQy/QVMiKNW8H3XRO8GpSlePB0+R1YPmBwaSPOA8L6fOFh/rfrqAXlmpg577D4i2Z+0Y6pgvYo89aY9TOSOtLe06D9GZ512oTbiiPjDZ5sfAwdM55H9H0xIHkTFVC7+NzQ8IpGEoAPPeU9g7HF/nriOZsAJCQ3SiS5AJb2bl35Oyq3e5D0BN+hSNuuAt9qx9ev533fd24InaCcHkXiMIS7b2Z9Hcyk0xYnKdXYqFBGKAl0M4K6BFg3zhrF+Ol1bRZtUnDYE9c4gnL68OskN42s/avXZrXg9gz9lgv0h8NZTO8ZmzX87PKy6ofUhIAKcg9yzgRo2rWcycbFqSyVsxKWcN5+8bPL4AuaW6fHg==">
</div>

<div>

	<input type="hidden" name="__VIEWSTATEGENERATOR" id="__VIEWSTATEGENERATOR" value="10C1FD69">
</div>

					
					 
					<div class="header">
					    <a name="Main"></a>
					    <a name="_articleTop" id="_articleTop"></a>

					    
						<div>
							<span id="ctl00_TagListHorz_TagWrp" class="tags horizontal">

	
	

	
	<span id="ctl00_TagListHorz_VisibleTags"><div class="t"><a rel="tag" href="https://www.codeproject.com/Tags/Cplusplus" data-id="78">C++</a></div><div class="t"><a rel="tag" href="https://www.codeproject.com/Tags/delegates" data-id="1587">delegates</a></div><div class="t"><a rel="tag" href="https://www.codeproject.com/Tags/VS2013" data-id="2768">VS2013</a></div></span> 

	
	
</span>


						</div>
					    <div class="title">
					        <h1 id="ctl00_ArticleTitle">The Impossibly Fast C++ Delegates, Fixed</h1>
					    </div>

                        <div>
					        
					        <div class="entry flex-container">

								

                                <div class="flex-item" style="flex:1 1 auto">
                                    <div class="flex-container" style="justify-content:space-between;flex-wrap:wrap-reverse">
                                       <span id="ctl00_Authors" class="author flex-item"><a href="https://www.codeproject.com/script/Membership/View.aspx?mid=2291164" rel="author">Sergey Alexandrovich Kryukov</a></span> 

                                        <div class="flex-item" style="margin-top:-4px;">
                                            <div id="ctl00_RateArticle_RatingTable" class="small-text" data-objectref="2_1170503">

	<meta itemprop="upvoteCount" content="38">


	<div id="ctl00_RateArticle_RatingRow" class="flex-container rating-container large-stars">

					
		

		
		<div class="nowrap tooltip">

			
			<div id="ctl00_RateArticle_ResultNoHist" class="rating-result"><div class="flex-container rating-stars large-stars"><div><img src="./Resources/star-fill-lg.png" style="width:24px;height:24px"></div><div><img src="./Resources/star-fill-lg.png" style="width:24px;height:24px"></div><div><img src="./Resources/star-fill-lg.png" style="width:24px;height:24px"></div><div><img src="./Resources/star-fill-lg.png" style="width:24px;height:24px"></div><div><img src="./Resources/star-fill-lg.png" style="width:24px;height:24px"></div></div></div>
			

			
			

			
            

			
                

		</div>
		
	
		
		<div id="ctl00_RateArticle_VoteCountNoHist" class="rating-votes nowrap">5.00/5  (40 votes)</div>	

		

		
		<div class="rating-undo" title="Undo vote" style="margin-left:5px;display:none"></div>

		
		
	</div>

	
	

</div>

                                        </div>
                                    </div>

                                    <div class="flex-container" style="color:#666;font-size:smaller">
                                        <span id="ctl00_LastUpdated" class="date flex-item-tight" title="Date last updated">13 Feb 2017, last revision: 11 Mar 2017</span><a id="ctl00_LicenseLink" title="The MIT License" class="license flex-item-tight" href="http://www.opensource.org/licenses/mit-license.php">MIT</a><span id="ctl00_ReadingTime" class="stats flex-item-tight">11 min read</span><span id="ctl00_HorizontalStats" class="stats flex-item-tight"><span class="stats"><span title="Views"><img src="./Resources/views32.png" style="width:16px"> 94K</span> &nbsp; <span title="Downloads"><img src="./Resources/download32.png" style="width:16px"> 2.2K</span> &nbsp; </span></span>
                                    </div>
                                </div>
					        </div>

                            

                        </div>

                        <div id="ctl00_DescriptionSpot" class="summary">Derived work based on the article by Sergey Ryazanov The Impossibly Fast C++ Delegates: this good solution is fixed and further developed using C++11.</div><span id="ctl00_ThumbnailUrl" class="date" content="https://www.codeproject.com/script/Articles/Images/article100x80.png"></span>			

                    </div>
                    
					
					

					

					
					

					
					

						
					

					

						
						<div id="contentdiv" class="text">
						



<!-- Article Starts -->

<ul class="download">
	<li><a href="The-Impossibly-Fast-C++Delegates-Fixed.zip" style="">Download source code — 12.6 KB</a></li></ul>

<h2>Contents</h2>
<div id="TOC">
<ul style="list-style-type: none; list-style-image: initial">
	<li><a href="#what-is-added">What is Added?</a></li>	<li><a href="#usage-by-examples">Usage By Examples</a>
	<ul style="list-style-type: none; list-style-image: initial; margin-top: 0; margin-bottom: 0">
		<li><a href="#multicast-delegate-usage">Multicast Delegate Usage</a></li>		<li><a href="#multicast-invocation-with-return-object-handlers">Multicast Invocation with Return Object Handlers</a></li>	</ul>
	</li>	<li><a href="#why-its-fast">Why it’s Fast?</a></li>	<li><a href="#variadic-templates-and-parsing-of-template-parameters">Variadic Templates and Parsing of Template Parameters</a></li>	<li><a href="#lambda-expressions">Lambda Expressions</a></li>	<li><a href="#multicast-delegate">Multicast Delegate</a></li>	<li><a href="#are-the-delegates-comparable">Are the Delegates Comparable?</a></li>	<li><a href="#compatibility-and-build">Compatibility and Build</a></li></ul>
</div>

<p>This is a derived work based on the ideas published by <a href="https://www.codeproject.com/Members/Sergey-Ryazanov">Sergey Ryazanov</a> in his article “<a href="https://www.codeproject.com/articles/11015/the-impossibly-fast-c-delegates">The Impossibly Fast C++ Delegates</a>”, 18 Jul 2005.</p>

<p>I found the idea interesting, especially after reading the criticism in the discussion section. Even though the code and some approached do have certain problems, if not defeat the purpose of the delegates, at least partially, the idea of making the delegate very fast seems very fruitful, as well as the main technique. I hope I re-worked it into something really usable.</p>

<h2 id="what-is-added">What is Added?</h2>

<p>The code is written from scratch, based exclusively on the text of the original article where the idea is clearly expressed: the use of function stubs and filling the stub pointer from the template parameters of the factory methods. It is obvious that the types of the call parameters and the return type should be further abstracted out as template parameters. Naturally, it requires arbitrary number of parameters.</p>

<p>So, as a first step, I added the generalization for the class templates based on C++/11 <a href="https://en.wikipedia.org/wiki/Variadic_template#C.2B.2B">variadic templates</a>, combined with <a href="https://en.wikipedia.org/wiki/Partial_template_specialization#Partial_specialization">partial template specialization</a>, to create what Sergey called “preferred syntax”, <code>&lt;RET(PARAMS…)&gt;</code>, completely eliminating all the preprocessor code.</p>

<p>Notably, in general case, there are two levels of template and template instantiation: first, the delegate profile is instantiated by specifying the return and parameter types. On top of that, a desired <em>factory function</em> is instantiated by specifying the class type and its static or instance function. This way, the instantiation of a delegate profile and the target of invocation are carried apart in a near-optimal way.</p>

<p>As to the <em>factory functions</em>, first thing to do was to note that the can be given the same name (<a href="https://www.codeproject.com/Articles/891455/Some-Programming-Approaches-to-Neuro-Linguistic-Pr#a3">so called</a> “overloading”), in my choice, “<code>create</code>”.</p>

<p>I also added the practically important support of <a href="https://en.wikipedia.org/wiki/Anonymous_function#C.2B.2B_.28since_C.2B.2B11.29">lambda expressions</a> in the style similar to <code>std::function</code>. The delegate of the same time could be assigned to an instance of a lambda expression and called later. Importantly, the <a href="https://en.wikipedia.org/wiki/Closure_%28computer_programming%29">closure</a> <em>capture</em> performed by a lambda expression is preserved in the delegate instance.</p>

<p>All of the above is covered by a single <code>delegate</code> template class. I also added one more template, <code>multicast delegate</code>, in .NET style.</p>

<p>I also added <em>semantic</em> comparison between delegate instances of both types and comparison with null pointer, assignment operators giving the compiler the possibility to implicitly instantiate correspondent method templates through type <em>inference</em>, and similar small features.</p>

<p>Notably, the instances of both delegate types can be created as “empty”. It reflects the main paradigm of the delegate usage, when the delegate instance is hosted by some class; and the code using the class sets or adds its own handlers in the course of this usage.</p>

<p>Performance comparison was done with the use of <code>std::function</code>. In all cases where the time measurements might be considered as relatively valid (very roughly, starting from a hundred of delegate instances each called a hundred of times), the <code>delegate</code> type has shown superior performance compared with <code>std::function</code>. Roughly, depending on many factors, the gain in <code>delegate/std::function</code> creation time was from 10 to 60 times, and performance gain in the call operations was from 1.1 to 3 times. I performed the measurements on Windows in two platforms, x86 (IA-32) and x86-64, with <a href="http://clang.llvm.org/">Clang</a>, <a href="https://gcc.gnu.org/">GCC</a> and <a href="https://msdn.microsoft.com/en-us/library/60k1461a.aspx">Microsoft</a> compilers — see also <a href="#compatibility-and-build"> Compatibility and Build</a>.</p>

<h2 id="usage-by-examples">Usage By Examples</h2>

<div class="pre-lang" id="premain772691"><div>C++</div><div class="pre-action-link"><span class="code-collapse" data-index="772691" id="preShrink772691">Shrink ▲</span> &nbsp; <span id="copycode772691" class="copy-code" data-index="772691" style="visibility: visible;"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" viewBox="0 0 460 460" style="width: 16px;height:16px;" xml:space="preserve"><g><path d="M425.934,0H171.662c-18.122,0-32.864,14.743-32.864,32.864v77.134h30V32.864c0-1.579,1.285-2.864,2.864-2.864h254.272     c1.579,0,2.864,1.285,2.864,2.864v254.272c0,1.58-1.285,2.865-2.864,2.865h-74.729v30h74.729 c18.121,0,32.864-14.743,32.864-32.865V32.864C458.797,14.743,444.055,0,425.934,0z"></path><path d="M288.339,139.998H34.068c-18.122,0-32.865,14.743-32.865,32.865v254.272C1.204,445.257,15.946,460,34.068,460h254.272 c18.122,0,32.865-14.743,32.865-32.864V172.863C321.206,154.741,306.461,139.998,288.339,139.998z M288.341,430H34.068    c-1.58,0-2.865-1.285-2.865-2.864V172.863c0-1.58,1.285-2.865,2.865-2.865h254.272c1.58,0,2.865,1.285,2.865,2.865v254.273h0.001 C291.206,428.715,289.92,430,288.341,430z"></path></g></svg></span></div></div>
<pre id="pre772691" style="margin-top:0;" class="lang-cplusplus notranslate" data-language="c++" data-allowshrink="True" data-collapse="False" data-codeblock-processed="true"><span class="code-keyword">class</span> Sample {
public:
    <span class="code-keyword">double</span> InstanceFunction(<span class="code-keyword">int</span>, <span class="code-keyword">char</span>, <span class="code-keyword">const</span> <span class="code-keyword">char</span>*) { <span class="code-keyword">return</span> <span class="code-digit">0</span>.<span class="code-digit">1</span>; }
    <span class="code-keyword">double</span> ConstInstanceFunction(<span class="code-keyword">int</span>, <span class="code-keyword">char</span>, <span class="code-keyword">const</span> <span class="code-keyword">char</span>*) <span class="code-keyword">const</span> { <span class="code-keyword">return</span> <span class="code-digit">0</span>.<span class="code-digit">2</span>; }
    <span class="code-keyword">static</span> <span class="code-keyword">double</span> StaticFunction(<span class="code-keyword">int</span>, <span class="code-keyword">char</span>, <span class="code-keyword">const</span> <span class="code-keyword">char</span>*) { <span class="code-keyword">return</span> <span class="code-digit">0</span>.<span class="code-digit">3</span>; }
}; <span class="code-comment">//class Sample
</span>
<span class="code-comment">//...
</span>
Sample sample;
    
<span class="code-keyword">delegate</span><span class="code-keyword">&lt;</span><span class="code-keyword">double</span>(<span class="code-keyword">int</span>, <span class="code-keyword">char</span>, <span class="code-keyword">const</span> <span class="code-keyword">char</span>*)<span class="code-keyword">&gt;</span> d;

<span class="code-keyword">auto</span> dInstance = <span class="code-keyword">decltype</span>(d)::create<span class="code-keyword">&lt;</span>Sample, &amp;Sample::InstanceFunction<span class="code-keyword">&gt;</span>(&amp;sample);
<span class="code-keyword">auto</span> dConst = <span class="code-keyword">decltype</span>(d)::create<span class="code-keyword">&lt;</span>Sample, &amp;Sample::ConstInstanceFunction<span class="code-keyword">&gt;</span>(&amp;sample);
<span class="code-keyword">auto</span> dFunc = <span class="code-keyword">decltype</span>(d)::create<span class="code-keyword">&lt;</span>&amp;Sample::StaticFunction<span class="code-keyword">&gt;</span>();
<span class="code-comment">// same thing with non-class functions
</span>
dInstance(<span class="code-digit">0</span>, <span class="code-string">'</span><span class="code-string">A'</span>, <span class="code-string">"</span><span class="code-string">Instance method call"</span>);
dConst(<span class="code-digit">1</span>, <span class="code-string">'</span><span class="code-string">B'</span>, <span class="code-string">"</span><span class="code-string">Constant instance method call"</span>);
dFunc(<span class="code-digit">2</span>, <span class="code-string">'</span><span class="code-string">C'</span>, <span class="code-string">"</span><span class="code-string">Static function call"</span>);

<span class="code-keyword">int</span> touchPoint = <span class="code-digit">1</span>;
<span class="code-keyword">auto</span> lambda = [&amp;touchPoint](<span class="code-keyword">int</span> i, <span class="code-keyword">char</span> c, <span class="code-keyword">const</span> <span class="code-keyword">char</span>* msg) -<span class="code-keyword">&gt;</span> <span class="code-keyword">double</span> {
    <span class="code-sdkkeyword">std::cout</span> <span class="code-keyword">&lt;</span><span class="code-keyword">&lt;</span> msg <span class="code-keyword">&lt;</span><span class="code-keyword">&lt;</span> <span class="code-sdkkeyword">std::endl</span>;
    <span class="code-comment">// touch point is captured by ref, can change:
</span>    <span class="code-keyword">return</span> (++touchPoint + (<span class="code-keyword">int</span>)c) * <span class="code-digit">0</span>.<span class="code-digit">1</span> - i;
}; <span class="code-comment">//lambda
</span>
<span class="code-keyword">decltype</span>(d) dLambda = lambda; <span class="code-comment">// lambda to delegate
</span><span class="code-comment">// or:
</span><span class="code-comment">//decltype(d) dLambda(lambda);
</span>
<span class="code-keyword">if</span> (d == <span class="code-keyword">nullptr</span>) <span class="code-comment">// true
</span>    d(<span class="code-digit">1</span>, <span class="code-string">'</span><span class="code-string">1'</span>, <span class="code-string">"</span><span class="code-string">lambda call"</span>); <span class="code-comment">//won't
</span>
d = dLambda; <span class="code-comment">// delegate to delegate
</span>
<span class="code-keyword">if</span> (d == dLambda) <span class="code-comment">// true, and also d != nullptr
</span>    d(<span class="code-digit">1</span>, <span class="code-string">'</span><span class="code-string">1'</span>, <span class="code-string">"</span><span class="code-string">lambda call"</span>); <span class="code-comment">//will be called</span></pre>

<p>By the way, compare this usage in the cases of class/struct instance function with the same thing using <code>std::function</code>:</p>

<div class="pre-lang" id="premain492069"><div>C++</div><div class="pre-action-link"><span id="copycode492069" class="copy-code" data-index="492069" style="visibility: visible;"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" viewBox="0 0 460 460" style="width: 16px;height:16px;" xml:space="preserve"><g><path d="M425.934,0H171.662c-18.122,0-32.864,14.743-32.864,32.864v77.134h30V32.864c0-1.579,1.285-2.864,2.864-2.864h254.272     c1.579,0,2.864,1.285,2.864,2.864v254.272c0,1.58-1.285,2.865-2.864,2.865h-74.729v30h74.729 c18.121,0,32.864-14.743,32.864-32.865V32.864C458.797,14.743,444.055,0,425.934,0z"></path><path d="M288.339,139.998H34.068c-18.122,0-32.865,14.743-32.865,32.865v254.272C1.204,445.257,15.946,460,34.068,460h254.272 c18.122,0,32.865-14.743,32.865-32.864V172.863C321.206,154.741,306.461,139.998,288.339,139.998z M288.341,430H34.068    c-1.58,0-2.865-1.285-2.865-2.864V172.863c0-1.58,1.285-2.865,2.865-2.865h254.272c1.58,0,2.865,1.285,2.865,2.865v254.273h0.001 C291.206,428.715,289.92,430,288.341,430z"></path></g></svg></span></div></div>
<pre id="pre492069" style="margin-top:0;" class="lang-cplusplus notranslate" data-language="c++" data-allowshrink="True" data-collapse="False" data-codeblock-processed="true"><span class="code-comment">//...
</span>
Sample sample;  
<span class="code-keyword">using</span> <span class="code-keyword">namespace</span> <span class="code-sdkkeyword">std::placeholders</span>;
<span class="code-sdkkeyword">std::function</span><span class="code-keyword">&lt;</span><span class="code-keyword">double</span>(<span class="code-keyword">double</span>(<span class="code-keyword">int</span>, <span class="code-keyword">char</span>, <span class="code-keyword">const</span> <span class="code-keyword">char</span>*))<span class="code-keyword">&gt;</span> f
    = <span class="code-sdkkeyword">std::bind</span>(&amp;Sample::InstanceFunction, &amp;sample, _1);</pre>

<p>The confusing part is the use of <code>std::placeholders</code> and <code>_1</code> (which is used to express the notion of the instance pointer passed as the first implicit parameter to the instance function call), which hardly looks obvious.</p>

<h3 id="multicast-delegate-usage">Multicast Delegate Usage</h3>

<div class="pre-lang" id="premain964410"><div>C++</div><div class="pre-action-link"><span id="copycode964410" class="copy-code" data-index="964410" style="visibility: visible;"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" viewBox="0 0 460 460" style="width: 16px;height:16px;" xml:space="preserve"><g><path d="M425.934,0H171.662c-18.122,0-32.864,14.743-32.864,32.864v77.134h30V32.864c0-1.579,1.285-2.864,2.864-2.864h254.272     c1.579,0,2.864,1.285,2.864,2.864v254.272c0,1.58-1.285,2.865-2.864,2.865h-74.729v30h74.729 c18.121,0,32.864-14.743,32.864-32.865V32.864C458.797,14.743,444.055,0,425.934,0z"></path><path d="M288.339,139.998H34.068c-18.122,0-32.865,14.743-32.865,32.865v254.272C1.204,445.257,15.946,460,34.068,460h254.272 c18.122,0,32.865-14.743,32.865-32.864V172.863C321.206,154.741,306.461,139.998,288.339,139.998z M288.341,430H34.068    c-1.58,0-2.865-1.285-2.865-2.864V172.863c0-1.58,1.285-2.865,2.865-2.865h254.272c1.58,0,2.865,1.285,2.865,2.865v254.273h0.001 C291.206,428.715,289.92,430,288.341,430z"></path></g></svg></span></div></div>
<pre id="pre964410" style="margin-top:0;" class="lang-cplusplus notranslate" data-language="c++" data-allowshrink="True" data-collapse="False" data-codeblock-processed="true">multicast_delegate<span class="code-keyword">&lt;</span><span class="code-keyword">double</span>(<span class="code-keyword">int</span>, <span class="code-keyword">char</span>, <span class="code-keyword">const</span> <span class="code-keyword">char</span>*)<span class="code-keyword">&gt;</span> md;
multicast_delegate<span class="code-keyword">&lt;</span><span class="code-keyword">double</span>(<span class="code-keyword">int</span>, <span class="code-keyword">char</span>, <span class="code-keyword">const</span> <span class="code-keyword">char</span>*)<span class="code-keyword">&gt;</span> mdSecond;
<span class="code-keyword">if</span> (md == <span class="code-keyword">nullptr</span>) <span class="code-comment">// true
</span>    md(<span class="code-digit">5</span>, <span class="code-string">'</span><span class="code-string">6'</span>, <span class="code-string">"</span><span class="code-string">zero calls"</span>); <span class="code-comment">//won't
</span><span class="code-comment">// add some of the delegate instances:
</span>md += mdSecond; <span class="code-comment">// nothing happens to md
</span>md += d; <span class="code-comment">// invocation list: size=1
</span>md += dLambda; <span class="code-comment">// invocation list: size=2
</span><span class="code-keyword">if</span> (md == dLambda) <span class="code-comment">//false
</span>    <span class="code-sdkkeyword">std::cout</span> <span class="code-keyword">&lt;</span><span class="code-keyword">&lt;</span> <span class="code-string">"</span><span class="code-string">md == dLambda"</span> <span class="code-keyword">&lt;</span><span class="code-keyword">&lt;</span> <span class="code-sdkkeyword">std::endl</span>;
<span class="code-keyword">if</span> (dLambda == md) <span class="code-comment">//false
</span>    <span class="code-sdkkeyword">std::cout</span> <span class="code-keyword">&lt;</span><span class="code-keyword">&lt;</span> <span class="code-string">"</span><span class="code-string">dLambda == md"</span> <span class="code-keyword">&lt;</span><span class="code-keyword">&lt;</span> <span class="code-sdkkeyword">std::endl</span>;
<span class="code-keyword">if</span> (md == mdSecond) <span class="code-comment">//false
</span>    <span class="code-sdkkeyword">std::cout</span> <span class="code-keyword">&lt;</span><span class="code-keyword">&lt;</span> <span class="code-string">"</span><span class="code-string">md == mdSecond"</span> <span class="code-keyword">&lt;</span><span class="code-keyword">&lt;</span> <span class="code-sdkkeyword">std::endl</span>;
<span class="code-comment">//adding lambda directly:
</span>md += lambda; <span class="code-comment">// invocation list: size=3
</span>    md(<span class="code-digit">7</span>, <span class="code-string">'</span><span class="code-string">8'</span>, <span class="code-string">"</span><span class="code-string">call them all"</span>);</pre>

<p>The above examples of multicast delegate usage discard the objects returned from each operation. All the code samples shown above can work with <code>void</code> return type. What to do with the return objects? They can be somehow accumulated; some of the values can be discarded, and so on. So, what solution would be the universal? It can be done by supplying a handler called on each return.</p>

<h3 id="multicast-invocation-with-return-object-handlers">Multicast Invocation with Return Object Handlers</h3>

<p>In addition to the <code>operator()</code>, the invocation with handling can be performed with a separate invocation template <code>operator()</code> with additional parameter — a handler for the returned objects:</p>

<div class="pre-lang" id="premain191539"><div>C++</div><div class="pre-action-link"><span id="copycode191539" class="copy-code" data-index="191539" style="visibility: visible;"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" viewBox="0 0 460 460" style="width: 16px;height:16px;" xml:space="preserve"><g><path d="M425.934,0H171.662c-18.122,0-32.864,14.743-32.864,32.864v77.134h30V32.864c0-1.579,1.285-2.864,2.864-2.864h254.272     c1.579,0,2.864,1.285,2.864,2.864v254.272c0,1.58-1.285,2.865-2.864,2.865h-74.729v30h74.729 c18.121,0,32.864-14.743,32.864-32.865V32.864C458.797,14.743,444.055,0,425.934,0z"></path><path d="M288.339,139.998H34.068c-18.122,0-32.865,14.743-32.865,32.865v254.272C1.204,445.257,15.946,460,34.068,460h254.272 c18.122,0,32.865-14.743,32.865-32.864V172.863C321.206,154.741,306.461,139.998,288.339,139.998z M288.341,430H34.068    c-1.58,0-2.865-1.285-2.865-2.864V172.863c0-1.58,1.285-2.865,2.865-2.865h254.272c1.58,0,2.865,1.285,2.865,2.865v254.273h0.001 C291.206,428.715,289.92,430,288.341,430z"></path></g></svg></span></div></div>
<pre id="pre191539" style="margin-top:0;" class="lang-cplusplus notranslate" data-language="c++" data-allowshrink="True" data-collapse="False" data-codeblock-processed="true"><span class="code-keyword">double</span> total = <span class="code-digit">0</span>;
md(<span class="code-digit">9</span>, <span class="code-string">'</span><span class="code-string">a'</span>, <span class="code-string">"</span><span class="code-string">handling the return values:"</span>,
    [&amp;total](<span class="code-sdkkeyword">size_t</span> index, <span class="code-keyword">double</span>* ret) -<span class="code-keyword">&gt;</span> <span class="code-keyword">void</span> {
        <span class="code-sdkkeyword">std::cout</span> <span class="code-keyword">&lt;</span><span class="code-keyword">&lt;</span> <span class="code-string">"</span><span class="code-string">\t"</span>
            <span class="code-keyword">&lt;</span><span class="code-keyword">&lt;</span> <span class="code-string">"</span><span class="code-string">index: "</span>
            <span class="code-keyword">&lt;</span><span class="code-keyword">&lt;</span> index
            <span class="code-keyword">&lt;</span><span class="code-keyword">&lt;</span> <span class="code-string">"</span><span class="code-string">; returned: "</span> <span class="code-keyword">&lt;</span><span class="code-keyword">&lt;</span> *ret
            <span class="code-keyword">&lt;</span><span class="code-keyword">&lt;</span> <span class="code-sdkkeyword">std::endl</span>;
            total += *ret;
});</pre>

<p>Note that the handler shown here is the instance of the <code>delegate</code> template class created from a lambda expression. There is another form of the handler based on <code>std::function</code>. Interestingly, no function template instantiation is required, as the type of the handler can be <em>deduced</em> (<em>inferred</em>) by a compiler from the context.</p>

<p>This code sample demonstrates the effect of enclosure capture used to accumulate the returned values in <code>total</code>. Of course, any other logic can be used; see also “DelegateDemo.h”.</p>

<h2 id="why-its-fast">Why it’s Fast?</h2>

<p>The basic idea is explained in the <a href="https://www.codeproject.com/articles/11015/the-impossibly-fast-c-delegates">article by S. Ryazanov</a>.</p>

<p>The mechanism is fast because good part of work is delegated to the compile-time phase of the product life time.</p>

<p>The delegate invocation call, <code>operator ()</code>, has only one level of indirection, a call to one of three <em>stub</em> functions (I added one more to support <em>lambda</em>). The address of an original method is not stored in the delegate class instance; instead, it is created during compile time, template instantiation. This way, each fragment of code creating an instance of a delegate based on a distinct function, instantiates a separate version of the stub. In each stub, the address of the function to be called is presented to the compiler as an <em>immediate constant</em>. Only one pointer is passed during run time: the pointer to the object used as “<code>this</code>” call argument (with the overhead of passing <code>nullptr</code> for static functions), which I later started to reuse as a pointer to a <em>lambda expression</em> instance, to support lambda.</p>

<p>Important performance factor here is the absence of any runtime check which could be used to distinguish all four cases: instance function of a class, constant instance function of a class, static function and lambda expression. According to my brief and not very accurate research, such check would almost double the execution time related to the invocation mechanism overhead.</p>

<h2 id="variadic-templates-and-parsing-of-template-parameters">Variadic Templates and Parsing of Template Parameters</h2>

<p>This is the technique used to provide the structured function-like syntax for template parameters:</p>

<div class="pre-lang" id="premain36419"><div>C++</div><div class="pre-action-link"><span id="copycode36419" class="copy-code" data-index="36419" style="visibility: visible;"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" viewBox="0 0 460 460" style="width: 16px;height:16px;" xml:space="preserve"><g><path d="M425.934,0H171.662c-18.122,0-32.864,14.743-32.864,32.864v77.134h30V32.864c0-1.579,1.285-2.864,2.864-2.864h254.272     c1.579,0,2.864,1.285,2.864,2.864v254.272c0,1.58-1.285,2.865-2.864,2.865h-74.729v30h74.729 c18.121,0,32.864-14.743,32.864-32.865V32.864C458.797,14.743,444.055,0,425.934,0z"></path><path d="M288.339,139.998H34.068c-18.122,0-32.865,14.743-32.865,32.865v254.272C1.204,445.257,15.946,460,34.068,460h254.272 c18.122,0,32.865-14.743,32.865-32.864V172.863C321.206,154.741,306.461,139.998,288.339,139.998z M288.341,430H34.068    c-1.58,0-2.865-1.285-2.865-2.864V172.863c0-1.58,1.285-2.865,2.865-2.865h254.272c1.58,0,2.865,1.285,2.865,2.865v254.273h0.001 C291.206,428.715,289.92,430,288.341,430z"></path></g></svg></span></div></div>
<pre id="pre36419" style="margin-top:0;" class="lang-cplusplus notranslate" data-language="c++" data-allowshrink="True" data-collapse="False" data-codeblock-processed="true"><span class="code-keyword">template</span> <span class="code-keyword">&lt;</span><span class="code-keyword">typename</span> T<span class="code-keyword">&gt;</span> <span class="code-keyword">class</span> <span class="code-keyword">delegate</span>;

<span class="code-keyword">template</span><span class="code-keyword">&lt;</span><span class="code-keyword">typename</span> RET, <span class="code-keyword">typename</span> ...PARAMS<span class="code-keyword">&gt;</span>
<span class="code-keyword">class</span> <span class="code-keyword">delegate</span><span class="code-keyword">&lt;</span>RET(PARAMS...)<span class="code-keyword">&gt;</span> <span class="code-keyword">final</span> : <span class="code-keyword">private</span> delegate_base<span class="code-keyword">&lt;</span>RET(PARAMS...)<span class="code-keyword">&gt;</span> {
    <span class="code-comment">//...
</span>};</pre>

<p>The specialization <code>delegate&lt;RET(PARAMS…)&gt;</code> creates the convenient profile for template instantiation, similar to the template <code>std::function</code>:</p>

<div class="pre-lang" id="premain78244"><div>C++</div><div class="pre-action-link"><span id="copycode78244" class="copy-code" data-index="78244" style="visibility: visible;"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" viewBox="0 0 460 460" style="width: 16px;height:16px;" xml:space="preserve"><g><path d="M425.934,0H171.662c-18.122,0-32.864,14.743-32.864,32.864v77.134h30V32.864c0-1.579,1.285-2.864,2.864-2.864h254.272     c1.579,0,2.864,1.285,2.864,2.864v254.272c0,1.58-1.285,2.865-2.864,2.865h-74.729v30h74.729 c18.121,0,32.864-14.743,32.864-32.865V32.864C458.797,14.743,444.055,0,425.934,0z"></path><path d="M288.339,139.998H34.068c-18.122,0-32.865,14.743-32.865,32.865v254.272C1.204,445.257,15.946,460,34.068,460h254.272 c18.122,0,32.865-14.743,32.865-32.864V172.863C321.206,154.741,306.461,139.998,288.339,139.998z M288.341,430H34.068    c-1.58,0-2.865-1.285-2.865-2.864V172.863c0-1.58,1.285-2.865,2.865-2.865h254.272c1.58,0,2.865,1.285,2.865,2.865v254.273h0.001 C291.206,428.715,289.92,430,288.341,430z"></path></g></svg></span></div></div>
<pre id="pre78244" style="margin-top:0;" class="lang-cplusplus notranslate" data-language="c++" data-allowshrink="True" data-collapse="False" data-codeblock-processed="true"><span class="code-keyword">delegate</span><span class="code-keyword">&lt;</span><span class="code-keyword">double</span>(<span class="code-keyword">int</span>, <span class="code-keyword">const</span> string*)<span class="code-keyword">&gt;</span> del;
<span class="code-keyword">delegate</span><span class="code-keyword">&lt;</span><span class="code-keyword">void</span>(double&amp;)<span class="code-keyword">&gt;</span> byRefVoidDel;
<span class="code-comment">// ...and the like</span></pre>

<h2 id="lambda-expressions">Lambda Expressions</h2>

<p>The idea behind the lambda is to reuse the “<code>this</code>” pointer in the delegate instance data. In other cases, this pointer is used to hold the instance pointer of the class which instance method is used in the delegate, to pass it as the first (normally implicit) parameter of the method call.</p>

<p>To perform the lambda expression call, I added one more stub function, <code>lambda_stub</code> (see “Delegate.h”):</p>

<div class="pre-lang" id="premain445679"><div>C++</div><div class="pre-action-link"><span id="copycode445679" class="copy-code" data-index="445679" style="visibility: visible;"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" viewBox="0 0 460 460" style="width: 16px;height:16px;" xml:space="preserve"><g><path d="M425.934,0H171.662c-18.122,0-32.864,14.743-32.864,32.864v77.134h30V32.864c0-1.579,1.285-2.864,2.864-2.864h254.272     c1.579,0,2.864,1.285,2.864,2.864v254.272c0,1.58-1.285,2.865-2.864,2.865h-74.729v30h74.729 c18.121,0,32.864-14.743,32.864-32.865V32.864C458.797,14.743,444.055,0,425.934,0z"></path><path d="M288.339,139.998H34.068c-18.122,0-32.865,14.743-32.865,32.865v254.272C1.204,445.257,15.946,460,34.068,460h254.272 c18.122,0,32.865-14.743,32.865-32.864V172.863C321.206,154.741,306.461,139.998,288.339,139.998z M288.341,430H34.068    c-1.58,0-2.865-1.285-2.865-2.864V172.863c0-1.58,1.285-2.865,2.865-2.865h254.272c1.58,0,2.865,1.285,2.865,2.865v254.273h0.001 C291.206,428.715,289.92,430,288.341,430z"></path></g></svg></span></div></div>
<pre id="pre445679" style="margin-top:0;" class="lang-cplusplus notranslate" data-language="c++" data-allowshrink="True" data-collapse="False" data-codeblock-processed="true"><span class="code-keyword">template</span> <span class="code-keyword">&lt;</span><span class="code-keyword">typename</span> LAMBDA<span class="code-keyword">&gt;</span>
<span class="code-keyword">static</span> RET lambda_stub(<span class="code-keyword">void</span>* this_ptr, PARAMS... arg) {
    LAMBDA* p = <span class="code-keyword">static_cast</span><span class="code-keyword">&lt;</span>LAMBDA*<span class="code-keyword">&gt;</span>(this_ptr);
    <span class="code-keyword">return</span> (p-<span class="code-keyword">&gt;</span><span class="code-keyword">operator</span>())(arg...);
}</pre>

<p>The reason for such solution is this is related to what I already explained <a href="#why-its-fast">above</a> — too expensive overhead of possible check of the different cases.</p>

<p>In passing the lambda instance to the delegate instance, the most important problem is the support of the major lambda, closure capture. Notably, this feature is lost when a lambda instance is copied by value (if the capture set is not empty, the copy throws exception at its call). To me, such lambda design is questionable, but this is a standard behavior. Passing the instance by pointer created by the caller works, but this hardly could be a viable design, due to the need of dealing with null pointers. So, the only reasonable solution is to pass the lambda instance by constant reference and creation of the pointer inside the factory function.</p>

<p>This is how the factory function looks:</p>

<div class="pre-lang" id="premain669395"><div>C++</div><div class="pre-action-link"><span id="copycode669395" class="copy-code" data-index="669395" style="visibility: visible;"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" viewBox="0 0 460 460" style="width: 16px;height:16px;" xml:space="preserve"><g><path d="M425.934,0H171.662c-18.122,0-32.864,14.743-32.864,32.864v77.134h30V32.864c0-1.579,1.285-2.864,2.864-2.864h254.272     c1.579,0,2.864,1.285,2.864,2.864v254.272c0,1.58-1.285,2.865-2.864,2.865h-74.729v30h74.729 c18.121,0,32.864-14.743,32.864-32.865V32.864C458.797,14.743,444.055,0,425.934,0z"></path><path d="M288.339,139.998H34.068c-18.122,0-32.865,14.743-32.865,32.865v254.272C1.204,445.257,15.946,460,34.068,460h254.272 c18.122,0,32.865-14.743,32.865-32.864V172.863C321.206,154.741,306.461,139.998,288.339,139.998z M288.341,430H34.068    c-1.58,0-2.865-1.285-2.865-2.864V172.863c0-1.58,1.285-2.865,2.865-2.865h254.272c1.58,0,2.865,1.285,2.865,2.865v254.273h0.001 C291.206,428.715,289.92,430,288.341,430z"></path></g></svg></span></div></div>
<pre id="pre669395" style="margin-top:0;" class="lang-cplusplus notranslate" data-language="c++" data-allowshrink="True" data-collapse="False" data-codeblock-processed="true"><span class="code-keyword">template</span> <span class="code-keyword">&lt;</span><span class="code-keyword">typename</span> LAMBDA<span class="code-keyword">&gt;</span>
<span class="code-keyword">static</span> <span class="code-keyword">delegate</span> create(<span class="code-keyword">const</span> LAMBDA &amp; instance) {
    <span class="code-keyword">return</span> <span class="code-keyword">delegate</span>((<span class="code-keyword">void</span>*)(&amp;instance), lambda_stub<span class="code-keyword">&lt;</span>LAMBDA<span class="code-keyword">&gt;</span>);
}</pre>

<p>This is the formal way to instantiate the template for this function:</p>

<div class="pre-lang" id="premain954748"><div>C++</div><div class="pre-action-link"><span id="copycode954748" class="copy-code" data-index="954748" style="visibility: visible;"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" viewBox="0 0 460 460" style="width: 16px;height:16px;" xml:space="preserve"><g><path d="M425.934,0H171.662c-18.122,0-32.864,14.743-32.864,32.864v77.134h30V32.864c0-1.579,1.285-2.864,2.864-2.864h254.272     c1.579,0,2.864,1.285,2.864,2.864v254.272c0,1.58-1.285,2.865-2.864,2.865h-74.729v30h74.729 c18.121,0,32.864-14.743,32.864-32.865V32.864C458.797,14.743,444.055,0,425.934,0z"></path><path d="M288.339,139.998H34.068c-18.122,0-32.865,14.743-32.865,32.865v254.272C1.204,445.257,15.946,460,34.068,460h254.272 c18.122,0,32.865-14.743,32.865-32.864V172.863C321.206,154.741,306.461,139.998,288.339,139.998z M288.341,430H34.068    c-1.58,0-2.865-1.285-2.865-2.864V172.863c0-1.58,1.285-2.865,2.865-2.865h254.272c1.58,0,2.865,1.285,2.865,2.865v254.273h0.001 C291.206,428.715,289.92,430,288.341,430z"></path></g></svg></span></div></div>
<pre id="pre954748" style="margin-top:0;" class="lang-cplusplus notranslate" data-language="c++" data-allowshrink="True" data-collapse="False" data-codeblock-processed="true"><span class="code-keyword">auto</span> d = <span class="code-keyword">delegate</span><span class="code-keyword">&lt;</span><span class="code-keyword">double</span>(<span class="code-keyword">int</span>, <span class="code-keyword">char</span>, <span class="code-keyword">const</span> <span class="code-keyword">char</span>*)<span class="code-keyword">&gt;</span>
    ::create<span class="code-keyword">&lt;</span><span class="code-keyword">decltype</span>(lambda)<span class="code-keyword">&gt;</span>(lambda);</pre>

<p>(See the declaration of <code>d</code> and <code>lambda</code> <a href="#usage">above</a>.)</p>

<p>However, there is no a need to do it, because the lambda type will be deduced (inferred) by a compiler from the delegate type. So, it will work if <code>&lt;decltype(lambda)&gt;</code> is omitted from the code fragment shown above. Moreover, it could be done through the assignment operator defined for the <code>delegate</code> class:</p>

<div class="pre-lang" id="premain461062"><div>C++</div><div class="pre-action-link"><span id="copycode461062" class="copy-code" data-index="461062" style="visibility: visible;"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" viewBox="0 0 460 460" style="width: 16px;height:16px;" xml:space="preserve"><g><path d="M425.934,0H171.662c-18.122,0-32.864,14.743-32.864,32.864v77.134h30V32.864c0-1.579,1.285-2.864,2.864-2.864h254.272     c1.579,0,2.864,1.285,2.864,2.864v254.272c0,1.58-1.285,2.865-2.864,2.865h-74.729v30h74.729 c18.121,0,32.864-14.743,32.864-32.865V32.864C458.797,14.743,444.055,0,425.934,0z"></path><path d="M288.339,139.998H34.068c-18.122,0-32.865,14.743-32.865,32.865v254.272C1.204,445.257,15.946,460,34.068,460h254.272 c18.122,0,32.865-14.743,32.865-32.864V172.863C321.206,154.741,306.461,139.998,288.339,139.998z M288.341,430H34.068    c-1.58,0-2.865-1.285-2.865-2.864V172.863c0-1.58,1.285-2.865,2.865-2.865h254.272c1.58,0,2.865,1.285,2.865,2.865v254.273h0.001 C291.206,428.715,289.92,430,288.341,430z"></path></g></svg></span></div></div>
<pre id="pre461062" style="margin-top:0;" class="lang-cplusplus notranslate" data-language="c++" data-allowshrink="True" data-collapse="False" data-codeblock-processed="true"><span class="code-keyword">delegate</span><span class="code-keyword">&lt;</span><span class="code-keyword">double</span>(<span class="code-keyword">int</span>, <span class="code-keyword">char</span>, <span class="code-keyword">const</span> <span class="code-keyword">char</span>*)<span class="code-keyword">&gt;</span> dl = lambda;</pre>

<p><span style="font-size: 11pt; line-height: 115%">This is possible because of the template copy constructor and template assignment operator. Again, the template instantiation is not needed (and not possible for a constructor), because the template parameters are deduced (inferred) from delegate and lambda types.</span></p>

<h2 id="multicast-delegate">Multicast Delegate</h2>

<p>First of all, as multicast delegate represent the set of handlers in the form of <em>invocation list</em>, and the heap is used (this is the only piece of code where heap is used), much higher intrinsic performance cost of the list operation support and the list iteration totally absorbs fine performance detail of the list item call. And yet, the invocation list item holds the same pair of <code>this/stub</code> pointers as in <code>delegate</code>, not the pointer to a <code>delegate</code> instance.</p>

<p>A <code>multicast_delegate</code> instance is created with an empty invocation list, which can be then populated with items using a set of “<code>+=</code>” operators from other instances of <code>multicast_delegate</code>, <code>delegate</code> and from lambda expressions of matching profiles. When existing list items used, they are cloned.</p>

<h2 id="are-the-delegates-comparable">Are the Delegates Comparable?</h2>

<p>Yes, they are, despite the statements made in <a href="https://www.codeproject.com/articles/11015/the-impossibly-fast-c-delegates">Sergey’s article</a>. “Comparison” is not a fully accurate term in this case; all the talking is actually about the <a href="https://en.wikipedia.org/wiki/Equality_%28mathematics%29"><em>equality</em> or <em>identity</em></a> relation. As soon as this is meant by “comparison”, delegates are “comparable” — please see the set of “<code>==</code>” and “<code>!=</code>” operators. Several operators represent all cases of equality checks: each of the classes <code>delegate</code> and <code>multicast_delegate</code> can be equal or not equal to the instance of its own or another type, additionally, an instance of each type can be equal or not equal to <code>nullptr</code>. Taking into account <em>commutativity</em>, it gives 12 cases. For all of the purposes of such relation, this is a perfectly valid set of operators.</p>

<p><a href="https://www.codeproject.com/Members/Sergey-Ryazanov">Sergey</a> argued that “a delegate doesn’t contain a pointer to method”. But why? It actually <em>does</em> contain such pointer, only this pointer is not passed to a delegate instance during run time. Instead, all the template instantiations generate the all the method addresses in the form of <em>immediate constants</em>, so the comparison of such pointers is done correctly but indirectly, through the comparison of different stubs. If two stub pointers are different, it always means that underlying function pointers are different, and visa versa.</p>

<p>Two delegate instances created from the same function or the same class and same “<code>this</code>” pointer compare as identical. The same goes with the delegate instances created from some lambda expression instance. If, by some reason, someone manages to compile some fragment of source code independently in different compilation units and make those units link together successfully, it yields <em>different</em> classes and function pointers, not the same. Likewise, two separate lambda expressions in the same stack frame with identical code still produce two different types, which can be easily checked up; and this is done for a reason. In both cases, the delegate instances instantiated from these <em>not-really-identical</em> objects simply <em>must</em> compare as <em>not</em> identical.</p>

<p>After all, the set of “<code>==</code>” and “<code>!=</code>” operators defines the relationship on the set of delegate instances which matches the definition of <a href="https://en.wikipedia.org/wiki/Equivalence_relation">equivalence relation</a>: it is <em>reflective</em>, <em>symmetric</em> (<em>commutative</em>) and <em>transitive</em> — all that matters.</p>

<h2 id="compatibility-and-build">Compatibility and Build</h2>

<p>All the <code>delegate/multicast_delegate</code> solution is contained in just three files:</p>

<ul style="list-style-type: none; list-style-image: initial">
	<li>“DelegateBase.h”,</li>	<li>“Delegate.h”,</li>	<li>“MultiCastDelegate.h”;</li></ul>

<p>they include each other in the given order and can be added to any project.</p>

<p>The compiler should support <a href="https://en.wikipedia.org/wiki/C%2B%2B11">C++11</a> or later standard. For GCC, this is an option which should be set to <code>-std=c++11</code> or, say, <code>-std=c++14</code>.</p>

<p>The demo and benchmark project is provided in two forms: 1) Visual Studio 2015 solution and project using Microsoft C++ compiler and <a href="http://clang.llvm.org/">Clang</a> — see “CppDelegates.sln” and 2) <a href="http://www.codeblocks.org/">Code::Blocks</a> project using <a href="https://gcc.gnu.org/">GCC</a> — “ CPPDelegates.cbp”. For all other options, one can assemble a project or a make file by adding all “*.h” and “*.cpp” files in the code directory “CppDelegates”.</p>

<p>I tested the code with Visual Studio 2015, <a href="http://clang.llvm.org/">Clang</a> 4.0.0, <a href="https://gcc.gnu.org/">GCC</a> 5.1.0.</p>

<p>The C++ options included “disable language extensions” (<code>/Za</code> for Microsoft and Clang), which seems to be essential for Microsoft. However, with this option, one weird Microsoft problem is the failure to compile “<code>//</code>” comments at the end of a file; the problem can be solved, for example, by adding an empty line at the end of the file; I set up a “Microsoft guard” in the form of “<code>/* … */</code>” at the end of each file.</p>

<!-- Article Ends -->


						</div>
						

						
						<h2>License</h2>
						<div id="LicenseTerms"><p>This article, along with any associated source code and files, is licensed under <a href="http://www.opensource.org/licenses/mit-license.php" rel="license">The MIT License</a></p></div>
						

						
						<br>
						
						    <br>
						
						

						<div class="clearfix"></div>

						<div style="padding-top:8px">
							
						</div>

					

				    
					</form>

				</div>

				
				<div class="bottom-promo"> 
				    
				</div>
				
                
                

				
				
				

			</div>
			

            
            
            

        </div>
        

		
		<div class="site-footer">
			<div class="align-left">
				<a id="ctl00_PermaLink" href="https://www.codeproject.com/Articles/1170503/The-Impossibly-Fast-Cplusplus-Delegates-Fixed">Permalink</a><br>
				<br>
				<a id="ctl00_PrivacyLink" href="https://www.codeproject.com/info/privacy.aspx">Privacy</a><br>
    			<a id="ctl00_CookiePolicyLink" href="https://www.codeproject.com/info/cookie.aspx">Cookies</a><br>
                <a id="ctl00_TermsOfUseLink" href="https://www.codeproject.com/info/TermsOfUse.aspx">Terms of Use</a><br>
			</div>

            <div class="align-center">
				


<div class="page-width">
    Layout: <a id="ctl00_PageWidth_FixedT" title="Fixed width layout" rel="nofollow" class=" active" href="https://www.codeproject.com/Articles/1170503/The-Impossibly-Fast-Cplusplus-Delegates-Fixed?PageFlow=FixedWidth">fixed</a>
    |
    <a id="ctl00_PageWidth_FluidT" title="Fluid layout" rel="nofollow" href="https://www.codeproject.com/Articles/1170503/The-Impossibly-Fast-Cplusplus-Delegates-Fixed?PageFlow=Fluid">fluid</a>
</div>


				

				

	            

                <br>
			</div>
                
			<div class="align-right">
				Article Copyright 2017 by Sergey Alexandrovich Kryukov<br>Everything else
				Copyright © <a href="mailto:webmaster@codeproject.com">CodeProject</a>, 1999-2024<br>
                <br>
				Web01 
				2.8:2024-12-08:1<br>
			</div>
		</div>
		

		<br clear="all">
		
			

	</div> 
	</div> 
</div>







<script type="text/javascript"> // DEFERRED script

document.addEventListener('DOMContentLoaded', function() {

	new CodeBlocks().initialise('#contentdiv');
	
	$('.author-wrapper .description').shorten({showChars: 400});
	
	anchorAnimate();
	
	$('#__EVENTVALIDATION').attr('autocomplete', 'off');

})
</script>










<style type="text/css">.copied::after {  position: absolute;  right: 0;  display: inline-block; white-space: nowrap; content: 'copied'; color: #fff; background-color: #f90;  border-radius: 3px; padding:1px 8px; opacity: 0;  will-change: opacity, transform; animation: showcopied 1.5s ease; } @keyframes showcopied { 0% { opacity: 0; } 70% { opacity: 1; } 100% { opacity: 0; } } </style><canvas id="cv1" width="1px" height="1px" style="position:absolute;left:0;top:0;pointer-events:none"></canvas><canvas id="cv2" width="1px" height="1px" style="position:absolute;left:0;top:0;pointer-events:none"></canvas></body><grammarly-desktop-integration data-grammarly-shadow-root="true"><template shadowrootmode="open"><style>
      div.grammarly-desktop-integration {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
        -moz-user-select: none;
        -webkit-user-select: none;
        -ms-user-select:none;
        user-select:none;
      }

      div.grammarly-desktop-integration:before {
        content: attr(data-content);
      }
    </style><div aria-label="grammarly-integration" role="group" tabindex="-1" class="grammarly-desktop-integration" data-content="{&quot;mode&quot;:&quot;full&quot;,&quot;isActive&quot;:true,&quot;isUserDisabled&quot;:false}"></div></template></grammarly-desktop-integration></html>