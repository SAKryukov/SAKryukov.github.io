<!DOCTYPE html>
<!-- saved from url=(0082)https://www.codeproject.com/Tips/458846/Using-using-Statements-DisposalAccumulator -->
<html lang="en" data-lt-installed="true"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

	
	<link rel="preconnect" href="https://www.google-analytics.com/">

	<link rel="preconnect" href="https://www.codeproject.com/">


	<link rel="preload" href="./Resources/logo250x135.gif" as="image">


	<link rel="preload" href="https://www.codeproject.com/App_Themes/CodeProject/Img/logo135-bg.gif" as="image">
	<link rel="preload" href="./Resources/jquery-3.4.1.min.js.download" as="script" type="text/javascript">


	<title>Using using Statements: DisposalAccumulator &mdash; CodeProject</title> 
    
	<link type="text/css" rel="stylesheet" href="./Resources/Article.min.css">


    <script type="text/javascript" async="" src="./Resources/analytics.js.download"></script><script type="text/javascript" src="./Resources/jquery-3.4.1.min.js.download" defer=""></script>
<script type="text/javascript" src="./Resources/article.min.js.download" defer=""></script>

	
<meta http-equiv="content-language" content="en-US">

<meta name="Description" content="Helps to deal with irregular construction patterns of disposable objects">
<meta name="Keywords" content="">
<meta name="Author" content="Sergey Alexandrovich Kryukov">
<meta name="Rating" content="General">
<meta name="Revisit-After" content="1 days">
<meta name="application-name" content="CodeProject">
<meta name="google-translate-customization" content="d908bb7ce7aff658-4c2f3a504525c916-g629383f736781a8a-13">



<link rel="dns-prefetch" href="https://ajax.googleapis.com/"> 
<link rel="canonical" href="https://www.codeproject.com/Articles/458846/Using-using-Statements-DisposalAccumulator">
<meta name="twitter:card" content="summary">
<meta name="twitter:site" content="@CodeProject">
<meta name="og:site_name" content="CodeProject">
<meta name="twitter:creator" content="@CodeProject">
<meta property="og:type" content="article">
<meta property="article:published_time" content="9/13/2012 10:43:00 PM">
<meta property="article:modified_time" content="2/26/2013 2:38:00 AM">
<meta name="twitter:label1" content="Written by">
<meta name="twitter:data1" content="Sergey Alexandrovich Kryukov">
<meta property="og:url" content="https://www.codeproject.com/Articles/458846/Using-using-Statements-DisposalAccumulator">
<meta property="og:title" content="Using using Statements: DisposalAccumulator">
<meta property="og:description" content="Helps to deal with irregular construction patterns of disposable objects">


<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="apple-touch-icon" sizes="144x144" href="https://www.codeproject.com/favicon/apple-touch-icon.png"> 
<link rel="icon" type="image/png" sizes="32x32" href="https://www.codeproject.com/favicon/favicon-32x32.png"> 
<link rel="icon" type="image/png" sizes="16x16" href="https://www.codeproject.com/favicon/favicon-16x16.png"> 
<link rel="manifest" href="https://www.codeproject.com/favicon/manifest.json"> 
<link rel="mask-icon" href="https://www.codeproject.com/favicon/safari-pinned-tab.svg" color="#ff9900">
	<script type="application/ld+json">{
  "@context": "http://schema.org",
  "@type": "TechArticle",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://www.codeproject.com/Articles/458846/Using-using-Statements-DisposalAccumulator"
   },
  "name": "Using using Statements: DisposalAccumulator",
  "headline": "Using using Statements: DisposalAccumulator",
  "url": "https://www.codeproject.com/Articles/458846/Using-using-Statements-DisposalAccumulator",
  "discussionUrl": "https://www.codeproject.com/Articles/458846/Using-using-Statements-DisposalAccumulator#_comments",
  "isFamilyFriendly": "true",
  "image": "https://www.codeproject.com/App_Themes/CodeProject/Img/Article100.png",
  "commentCount": "0",
  "editor" : {
    "@type" : "Person",
    "name" : "Editor",
    "url" : "https://www.codeproject.com/script/Membership/View.aspx?mid=3866010"
  },
  "publisher" : {
    "@type" : "Organization",
    "name" : "CodeProject"
  },
  "description": "Helps to deal with irregular construction patterns of disposable objects",
  "author" : [{
      "@type" : "Person",
      "name" : "Sergey Alexandrovich Kryukov",
      "url" : "https://www.codeproject.com/script/Membership/View.aspx?mid=2291164"
    }],
  "datePublished": "2012-09-13",
  "dateCreated": "2012-09-13",
  "dateModified": "2013-02-26"
}</script>

<script type="text/javascript">
function defrm () { /* thanks twitter */
    document.write = '';
    window.top.location = window.self.location;
    setTimeout(function() { document.body.innerHTML = ''; }, 0);
    window.self.onload = function(evt) { document.body.innerHTML = ''; };
}

if (window.top !== window.self) {
    try {
        if (window.top.location.host) { /* will throw for all except chrome */ }
        else { defrm(); /* chrome */ }
    } catch (ex) { defrm(); /* everyone else */ }
}

// Specific case where a site is screwing with us.
if (typeof(DemoUrl) !== 'undefined') {
    document.write(unescape('%3Cme') + 'ta http' + '-equiv="re' + 'fresh con' +
                           'tent="1;url=' + DemoUrl + unescape('"%3CE'));
}
</script>
	





    <script async="" type="text/javascript" src="./Resources/js"></script>
    <script type="text/javascript">
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'UA-1735123-1' , {'user_id': '42a7d533-9829-4f88-8fc6-84dc936250c9'});
    </script>

<style type="text/css"></style></head>	

<body class="chrome chrome120" data-new-gr-c-s-check-loaded="14.1215.0" data-gr-ext-installed="">



<a class="access-link" href="#Main"><img alt="Click here to Skip to main content" src="./Resources/t.gif"></a>




<div class="page-background">

	
	

	

	
    <div id="ctl00_STM" class="site-top-menu fixed narrow">
        <div class="main-content">
            

<div class="container memberbar clearfix flex-container flex-extend">

	<div id="ctl00_MemberBar_GenInfo" class="flex-item align-left">65,938 articles</div>
	
	<div id="ctl00_MemberBar_ChangeNotice" class="flex-item align-left">CodeProject
	is changing. <a href="https://www.codeproject.com/info/Changes.aspx">Read more</a>.</div>

	<div class="flex-item">
		
	</div>

	<div class="flex-item align-right">

		

		

		
	</div>
</div>
        </div>
    </div>

	
    <div id="ctl00_SH" class="site-header fixed narrow">
        <div class="main-content">
            <div class="logo"><a href="https://www.codeproject.com/"><img id="ctl00_Logo" tabindex="1" title="CodeProject" src="./Resources/logo250x135.gif" alt="Home" style="height:135px;width:250px;border-width:0px;"></a></div>
            <div class="promo"></div>
        </div>
    </div>

	
			
	

	<div id="A" class="container-content-wrap fixed narrow"> 

	<div class="container-content">

        
		<div class="clearfix">
			<div class="container-breadcrumb float-left ">
				<div><a rel="nofollow" href="https://www.codeproject.com/script/Content/SiteMap.aspx">Articles</a></div>
			</div>

            <div class="float-left">
				
			</div>

			<div class="edit-links float-right">
				



 
&nbsp;










			</div>

			<div class="article-nav float-right">
				


<div style="display:inline-block;position:relative;top:-6px;margin-right:20px">
    
</div>



 

<a id="ctl00_ActionLinks_PrintMd" data-tooltip="Print" data-enabletooltip="true" data-width="auto" href="https://www.codeproject.com/Articles/458846/Using-using-Statements-DisposalAccumulator?display=Print" class="tooltip" title="">
   <img src="./Resources/print48.png" width="24" height="24" style="border:0">
<div class="speech-bubble-container-up" style="width:auto">  <div class="speech-bubble-up" style="text-align:center"> Print</div>  <div class="speech-bubble-pointer-up">    <div class="speech-bubble-pointer-up-inner"></div>  </div></div></a>



<span id="ctl00_ActionLinks_R">
    
    
</span>
			</div>
		</div>

        
		<div class="extended article-container-parts">

			
		    
            

			
			<div id="AT" class="article-container  fixed narrow" style="max-width:inherit;"> 

				<div class="article">

					<form name="aspnetForm" method="post" action="https://www.codeproject.com/Tips/458846/View.aspx" id="aspnetForm" style="margin:0;padding:0">
<div>
<input type="hidden" name="__VIEWSTATE" id="__VIEWSTATE" value="9CQ6+5Y7GIz04PzxCn1J+FWDRFVCbU/IJH42nwVVW/Uf51nkS2nVVeEdXQK/qpt2urt/GD6SNWQuwkSx3U0OH35ZojeUrZBf+aqOIuE38/x0KbQq/bbjRMq9ilw2cDa0Mzx0Z876e6dbkxyzTc4HgJbPwsgqKNtxOFaChjVL+zJI+EpFR/4yusOBpk8us2hJOuj2a6gQi1X5ardl5JnDldBE0DoOZh3PnXhQ5O3DhMELon12lN8ki54yYXMN2F5lDL8wqGpm6C/1TtMkEZC3znYwWBngaV0b68RAS97WK+Hu2Nhl8TGR4Zu7s0i/96656t3cTpbrgO1xYKxTaRJ8gFjURz437WiSexZVGZr7TQxC9iBc79A0wXF5/S34D3cWLyDtX2miTRUMtkLias7/yD311X13PWGftZOgT3LAWDiFzkDOO4zROk4V+wCAOxFu2oxkbu/ksK46SpZ7jwwmZZKJGmiVbeLSlOz93H59x6TaxGMOrJ4ezNF4ZUyB65wbMJ2Q5pC/YQufa5NEC+jpeykhZcVBiS9vefj1abVnQnDRUL/Y5yEELSSEVygEmxxmhwtXcLcteBNeyDf8wEZ9Nczvxf5fWDAOZvP7/B7azGSPiLH3B7xMjv6cSYF1OSFQvYr9AJLJ1decHwpuOayVGdMK/54SyTiul/4cVn5I+rxhDdYRZ/Ey09aOIJbT8D8GiFgINu701E8NvNLsHZikoXApjT9AgzzoAgB8A3L5zRzr8rqSRCb6zGjWEre4GjSk6wQjJhKkIhLTKN8L5xCMHRs5fRIZwB5qzcTFqJ0rX8GrjuoZRagynTWv+S4N1W/n0S4/1eP66Q8W7y/T+1OVW2BNSxOC6c3RJpg6G6JY3hRngBGYwFOJlspxr4BeB4FKYk5Tz8Ft43mhrdJCsTEIt1aADLrlyXsnQc6jxpk10amlgjGY5I8/kdEaWmcguZMIlv9rP0qBUafzF8Snm8vX9UBEfPZu3/FCcbVEr7jujkk/qCV5H/HBSlr6CkAaRycSqEbxz8JesBa+LhiIEuoqrqStRaZPiHFPJU6sIhb+Q4M93r4N2SvxzWvX3AqVXr4HimzaozfqyLUiOeJaE9Akpz81MGmp6nlO/z62Wk/4pPxB8MY8INStP4CAlZdGgicd5+wT1p5P7fr/1Bbpsu+U0lIqU1VhVxriRlSleZGIcXS/Dz46IsQVxCKC1V9+zrPg7rKYTSnO9dNi3dTw0t6HOwX5staa9V3I6H8vLW72pR0Y1mVmF1TBYEcg1DD9iPy8MS66MKVKtLLInrJmL3vTWnfl3IssskvoT3Z8dkawzhx7G30NLQsq994hE6BVaSQlIgcd6DOh9LdL42sfhuPkqcF8ueUcJYNHRyT/nsOl5mEbc2sy10xhXV18jjCoJ1u2OCHDTLm0ArtraCb5er0dgp5AYeFeWQkjhHjVfAfdQkOlKVU4VfdQql6KWF2cSaZ/O6DA+cWsTpvFZFwwo55ZLgYQhDwvStCMSvrFqLa4goFVkjAlhx2RI1JsEvfDMCZ80X13jeI6AqkFMPE4CJ4N3JZurDbaW/nnMMIx7C2O2MR8rRpNcf66JcXHkLIrEjJNK/nZjruk4q/QWFkOVFrBxr4kEaR+FGPCKJP5wxmhvwAwFNftj/0q4EgMSTDdaqsZaUjS/NtYH0gc3IJrtRseDJsQ54a9hnXeqEu/8jk9N7plxGyTQEBU/h+qnXnDGtHBbhcsEdbOmM1ZI3upSPoLb5fBa+Y7YaFw9znW495y2VixEmVL5tow41MTRL0yATxHDWXnlg==">
</div>

<div>

	<input type="hidden" name="__VIEWSTATEGENERATOR" id="__VIEWSTATEGENERATOR" value="10C1FD69">
</div>

					
					 
					<div class="header">
					    <a name="Main"></a>
					    <a name="_articleTop" id="_articleTop"></a>

					    
						<div>
							<span id="ctl00_TagListHorz_TagWrp">

	
	

	
	<span id="ctl00_TagListHorz_VisibleTags" class="subdue">(untagged)</span> 

	
	
</span>


						</div>
					    <div class="title">
					        <h1 id="ctl00_ArticleTitle">Using <code style="font-size:100%">using</code> Statements: DisposalAccumulator</h1>
					    </div>

                        <div>
					        
					        <div class="entry flex-container">

								

                                <div class="flex-item" style="flex:1 1 auto">
                                    <div class="flex-container" style="justify-content:space-between;flex-wrap:wrap-reverse">
                                       <span id="ctl00_Authors" class="author flex-item"><a href="https://www.codeproject.com/script/Membership/View.aspx?mid=2291164" rel="author">Sergey Alexandrovich Kryukov</a></span> 

                                        <div class="flex-item" style="margin-top:-4px;">
                                            <div id="ctl00_RateArticle_RatingTable" class="small-text" data-objectref="2_458846">

	<meta itemprop="upvoteCount" content="0">


	<div id="ctl00_RateArticle_RatingRow" class="flex-container rating-container large-stars">

					
		

		
		<div class="nowrap tooltip">

			
			<div id="ctl00_RateArticle_ResultNoHist" class="rating-result"><div class="flex-container rating-stars large-stars"><div style="width:24px;position:relative" class="clipped"><img src="./Resources/star-empty-lg.png" style="width:24px;height:24px;position:absolute;top:0px;right:0"></div><div><img src="./Resources/star-empty-lg.png" style="width:24px;height:24px"></div><div><img src="./Resources/star-empty-lg.png" style="width:24px;height:24px"></div><div><img src="./Resources/star-empty-lg.png" style="width:24px;height:24px"></div><div><img src="./Resources/star-empty-lg.png" style="width:24px;height:24px"></div></div></div>
			

			
			

			
            

			
                

		</div>
		
	
		
		<div id="ctl00_RateArticle_VoteCountNoHist" class="rating-votes nowrap">0.00/5  (No votes)</div>	

		

		
		<div class="rating-undo" title="Undo vote" style="margin-left:5px;display:none"></div>

		
		
	</div>

	
	

</div>

                                        </div>
                                    </div>

                                    <div class="flex-container" style="color:#666;font-size:smaller">
                                        <span id="ctl00_LastUpdated" class="date flex-item-tight" title="Date last updated">13 Sep 2012</span><span id="ctl00_HorizontalStats" class="stats flex-item-tight"><span class="stats"><span title="Views"><img src="./Resources/views32.png" style="width:16px"> 1</span> &nbsp; </span></span>
                                    </div>
                                </div>
					        </div>

                            

                        </div>

                        <div id="ctl00_DescriptionSpot" class="summary">Helps to deal with irregular construction patterns of disposable objects</div><span id="ctl00_ThumbnailUrl" class="date" content="https://www.codeproject.com/script/Articles/Images/article100x80.png"></span>			

                    </div>
                    
					
					

					

					
					

					
					

						
					

					

						
						<div id="contentdiv" class="text">
						



<!-- Article Starts -->


<p dir="ltr" align="right">Epigraph:</p>

<p dir="ltr" align="right">Thanks to everyone; everyone is dismissed.</p>

<p dir="ltr" align="right"><em>Favorite film director's phrase, according to some movies about movie making</em> <big>😉</big></p>

<h2>Introduction </h2>

<p>This tip is based on my own practice but was recently inspired by my CodeProject colleague <a href="http://www.codeproject.com/Members/Mika-Wendelius">Mika Wendelius </a>who posed <a href="http://www.codeproject.com/Questions/458003/Conditional-using-block">a very interesting question in the CodeProject Questions &amp; Answers forum</a>.</p>

<p>Using a pattern based on the interface <code>System.IDisposable</code> and the C# <code>using</code> statement, he managed to face a very simple but representative case where <code>using</code> could dramatically damage the code reuse. I answered on the question on the same day, pointing out that the solution really depends on the relationships between classes involved in the instantiation under the <code>using</code> statement's resource acquisition part (the class declarations were not shown in the question). If two of the classes are related by inheritance, and one of the classes uses a late-bound constructor parameter, one pretty obvious resolution is possible without any repeated code fragments. I demonstrated this solution based on the assumption of having inheritance and late binding in those <code>IDisposable</code> classes. I also basically explained how a solution for a general case could look, but did not provide any code for that, because I think that Mika is more than enough qualified to get the idea and do everything by himself. Anyone can see this answer <a href="http://www.codeproject.com/Answers/458110/Conditional-using-block#answer4">here</a>. </p>

<p>The problem with the remarkable Mika's example is rooted in the clash between having dynamic (run-time) dependency between classes or structures instantiated under the <code>using</code> resource acquisition and the <code>using</code> construct structure being defined statically and frozen by compile time. When Mika introduces a condition affecting the dependency in the object graph, it broke the <code>static </code><code>using</code> structure.</p>

<p>I have a solution for this problem, but the exotic Mika's example is not the only case where this solution can be used. It was something I never thought of before (again, a wonderful example), but there are many more trivial examples which would make <code>using</code> just poorly readable and hence a subject of developer's mistakes. One such trivial case would be the one with the need of excessive <code>using</code> blocks nesting; a simple case where there are just too many disposable objects could also make using of <code>using</code> somewhat problematic.</p>

<p>That's why I think the simple technique I'm going to show could be of some interest to many members.</p>

<h2>The Problem</h2>

<p>I've slightly modified Mika's sample, to make it a bit simpler but to manifest the problem in a bit more dramatic way.</p>

<p>Consider the following method with two different nested <code>using</code> statements. I need this “naive” code sample to expose the problem: </p>

<div class="pre-lang" id="premain961957"><div>C#</div><div class="pre-action-link"><span class="copy-code" data-index="961957" id="copycode961957" style="visibility: visible;"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" viewBox="0 0 460 460" style="width: 16px;height:16px;" xml:space="preserve">
<g>
<path d="M425.934,0H171.662c-18.122,0-32.864,14.743-32.864,32.864v77.134h30V32.864c0-1.579,1.285-2.864,2.864-2.864h254.272
    c1.579,0,2.864,1.285,2.864,2.864v254.272c0,1.58-1.285,2.865-2.864,2.865h-74.729v30h74.729
    c18.121,0,32.864-14.743,32.864-32.865V32.864C458.797,14.743,444.055,0,425.934,0z"></path>
<path d="M288.339,139.998H34.068c-18.122,0-32.865,14.743-32.865,32.865v254.272C1.204,445.257,15.946,460,34.068,460h254.272
    c18.122,0,32.865-14.743,32.865-32.864V172.863C321.206,154.741,306.461,139.998,288.339,139.998z M288.341,430H34.068
    c-1.58,0-2.865-1.285-2.865-2.864V172.863c0-1.58,1.285-2.865,2.865-2.865h254.272c1.58,0,2.865,1.285,2.865,2.865v254.273h0.001
    C291.206,428.715,289.92,430,288.341,430z"></path>	
</g>
</svg></span></div></div><pre lang="cs" data-codeblock-processed="true" id="pre961957" style="margin-top: 0px;" class="notranslate"><span class="code-keyword">static</span> <span class="code-keyword">void</span> NaiveWay(<span class="code-keyword">bool</span> createSecond) {
    <span class="code-keyword">if</span> (createSecond)
        <span class="code-keyword">using</span> (First first = <span class="code-keyword">new</span> First()) {
            <span class="code-keyword">using</span> (Second second = <span class="code-keyword">new</span> Second(first)) {
                <span class="code-keyword">using</span> (Third third = <span class="code-keyword">new</span> Third(second)) {
                    third.DoSomething();
                } <span class="code-comment">//</span><span class="code-comment">disposing third
</span>            } <span class="code-comment">//</span><span class="code-comment">disposing second
</span>        } <span class="code-comment">//</span><span class="code-comment">disposing first
</span>    <span class="code-keyword">else</span> <span class="code-comment">//</span><span class="code-comment">oh, no! :-) the code reuse is lost:
</span>        <span class="code-keyword">using</span> (First first = <span class="code-keyword">new</span> First()) {
            <span class="code-keyword">using</span> (Third third = <span class="code-keyword">new</span> Third(first)) {
                third.DoSomething();
            } <span class="code-comment">//</span><span class="code-comment">disposing third
</span>        } <span class="code-comment">//</span><span class="code-comment">disposing first
</span>} <span class="code-comment">//</span><span class="code-comment">NaiveWay</span></pre>

<p>Apparently, this “naive” violates one of the most fundamental principles of programming: “<a href="http://en.wikipedia.org/wiki/Do_not_repeat_yourself">Don't repeat yourself</a>”. Such repeated code fragments is always a problem for code maintenance and hence they invite human mistakes and threaten code reliability. The two code fragments with different <code>using</code> structures should be somehow merged together, but how?</p>

<p>Why the two <code>if</code> branches would be needed? This is because the different values of the Boolean parameters dictate different nesting of <code>using</code> blocks, not just the structure of the object graph. As I pointed out in my answer referenced above, different class declarations and different object graphs can require such different <code>using</code> structures. Normally, different forms of the object graph depending on some conditions do not present any problems, but instantiation in the resource acquisition part of the <code>using</code> statements (please see the <a href="http://standards.iso.org/ittf/PubliclyAvailableStandards/c042926_ISO_IEC_23270_2006(E).zip">ISO/IEC 23270 of 09/01/2006 standard document</a>, section 15.3, “The <code>using </code>statement”) creates the problem. </p>

<p>In one case, all three classes could be not related by inheritance, but the different <code>using</code> structures could result from the fact that the class <code>Third</code> has two alternative constructors:</p>

<div class="pre-lang" id="premain18304"><div>C#</div><div class="pre-action-link"><span class="copy-code" data-index="18304" id="copycode18304" style="visibility: visible;"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" viewBox="0 0 460 460" style="width: 16px;height:16px;" xml:space="preserve">
<g>
<path d="M425.934,0H171.662c-18.122,0-32.864,14.743-32.864,32.864v77.134h30V32.864c0-1.579,1.285-2.864,2.864-2.864h254.272
    c1.579,0,2.864,1.285,2.864,2.864v254.272c0,1.58-1.285,2.865-2.864,2.865h-74.729v30h74.729
    c18.121,0,32.864-14.743,32.864-32.865V32.864C458.797,14.743,444.055,0,425.934,0z"></path>
<path d="M288.339,139.998H34.068c-18.122,0-32.865,14.743-32.865,32.865v254.272C1.204,445.257,15.946,460,34.068,460h254.272
    c18.122,0,32.865-14.743,32.865-32.864V172.863C321.206,154.741,306.461,139.998,288.339,139.998z M288.341,430H34.068
    c-1.58,0-2.865-1.285-2.865-2.864V172.863c0-1.58,1.285-2.865,2.865-2.865h254.272c1.58,0,2.865,1.285,2.865,2.865v254.273h0.001
    C291.206,428.715,289.92,430,288.341,430z"></path>	
</g>
</svg></span></div></div><pre lang="cs" data-codeblock-processed="true" id="pre18304" style="margin-top: 0px;" class="notranslate"><span class="code-keyword">using</span> System;

<span class="code-comment">//</span><span class="code-comment">...
</span>
<span class="code-keyword">class</span> First : IDisposable {
    <span class="code-keyword">void</span> IDisposable.Dispose() {<span class="code-comment">/*</span><span class="code-comment"> ... */</span>}
    <span class="code-comment">//</span><span class="code-comment">...
</span>} <span class="code-comment">//</span><span class="code-comment">class First
</span>
<span class="code-keyword">class</span> Second : IDisposable {
    <span class="code-keyword">internal</span> Second(First child) {<span class="code-comment">/*</span><span class="code-comment"> ... */</span>}
    <span class="code-keyword">void</span> IDisposable.Dispose() {<span class="code-comment">/*</span><span class="code-comment"> ... */</span>}
    <span class="code-comment">//</span><span class="code-comment">...
</span>} <span class="code-comment">//</span><span class="code-comment">class Second
</span>
<span class="code-keyword">class</span> Third : IDisposable {
    <span class="code-keyword">internal</span> Third(First child) {<span class="code-comment">/*</span><span class="code-comment"> ... */</span>}
    <span class="code-keyword">internal</span> Third(Second child) {<span class="code-comment">/*</span><span class="code-comment"> ... */</span>}
    <span class="code-keyword">internal</span> <span class="code-keyword">void</span> DoSomething() {<span class="code-comment">/*</span><span class="code-comment"> ... */</span>}
    <span class="code-keyword">void</span> IDisposable.Dispose() {<span class="code-comment">/*</span><span class="code-comment"> ... */</span>}
    <span class="code-comment">//</span><span class="code-comment">...
</span>} <span class="code-comment">//</span><span class="code-comment">class Third</span></pre>

<p>Another variant of declaration of the classes could also use identical <code>using</code> structures shown above. This is the case where the class <code>Third</code> uses the single constructor with the late bound run-time type of the input parameter: </p>

<div class="pre-lang" id="premain195730"><div>C#</div><div class="pre-action-link"><span class="copy-code" data-index="195730" id="copycode195730" style="visibility: visible;"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" viewBox="0 0 460 460" style="width: 16px;height:16px;" xml:space="preserve">
<g>
<path d="M425.934,0H171.662c-18.122,0-32.864,14.743-32.864,32.864v77.134h30V32.864c0-1.579,1.285-2.864,2.864-2.864h254.272
    c1.579,0,2.864,1.285,2.864,2.864v254.272c0,1.58-1.285,2.865-2.864,2.865h-74.729v30h74.729
    c18.121,0,32.864-14.743,32.864-32.865V32.864C458.797,14.743,444.055,0,425.934,0z"></path>
<path d="M288.339,139.998H34.068c-18.122,0-32.865,14.743-32.865,32.865v254.272C1.204,445.257,15.946,460,34.068,460h254.272
    c18.122,0,32.865-14.743,32.865-32.864V172.863C321.206,154.741,306.461,139.998,288.339,139.998z M288.341,430H34.068
    c-1.58,0-2.865-1.285-2.865-2.864V172.863c0-1.58,1.285-2.865,2.865-2.865h254.272c1.58,0,2.865,1.285,2.865,2.865v254.273h0.001
    C291.206,428.715,289.92,430,288.341,430z"></path>	
</g>
</svg></span></div></div><pre lang="cs" data-codeblock-processed="true" id="pre195730" style="margin-top: 0px;" class="notranslate"><span class="code-keyword">class</span> First : IDisposable {
    <span class="code-keyword">void</span> IDisposable.Dispose() {<span class="code-comment">/*</span><span class="code-comment"> ... */</span>}
    <span class="code-comment">//</span><span class="code-comment">...
</span>} <span class="code-comment">//</span><span class="code-comment">class First
</span>
<span class="code-keyword">class</span> Second : First, IDisposable {
    <span class="code-keyword">internal</span> Second(First child) {<span class="code-comment">/*</span><span class="code-comment"> ... */</span>}
    <span class="code-keyword">void</span> IDisposable.Dispose() {<span class="code-comment">/*</span><span class="code-comment"> ... */</span>}
    <span class="code-comment">//</span><span class="code-comment">...
</span>} <span class="code-comment">//</span><span class="code-comment">class Second
</span>
<span class="code-keyword">class</span> Third : IDisposable {
    <span class="code-keyword">internal</span> Third(First child) {<span class="code-comment">/*</span><span class="code-comment"> ... */</span>}
    <span class="code-keyword">internal</span> <span class="code-keyword">void</span> DoSomething() {<span class="code-comment">/*</span><span class="code-comment"> ... */</span>}
    <span class="code-keyword">void</span> IDisposable.Dispose() {<span class="code-comment">/*</span><span class="code-comment"> ... */</span>}
    <span class="code-comment">//</span><span class="code-comment">...
</span>} <span class="code-comment">//</span><span class="code-comment">class Third</span></pre>

<p>For the second case, I've demonstrated the solution shown in sample code in my answer referenced above. But this is a special case. How to overcome the difficulty explained in the present section above in a universal manner which would cover both cases of the object graph, as well as many more? </p>

<p>To approach the problem, let's remember that the purpose of using of the <code>using</code> statement the automatic call to the method <code>System.IDisposable.Dispose</code> and that it is strictly equivalent to some try-finally statement. (Please see <a href="http://msdn.microsoft.com/en-us/library/yh598w02.aspx">this link</a>.) Of course, if we try to write such equivalent <code>try</code>-<code>finally </code>statement, the problem of repeated code can be resolved. Let's see: </p>

<div class="pre-lang" id="premain569483"><div>C#</div><div class="pre-action-link"><span class="copy-code" data-index="569483" id="copycode569483" style="visibility: visible;"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" viewBox="0 0 460 460" style="width: 16px;height:16px;" xml:space="preserve">
<g>
<path d="M425.934,0H171.662c-18.122,0-32.864,14.743-32.864,32.864v77.134h30V32.864c0-1.579,1.285-2.864,2.864-2.864h254.272
    c1.579,0,2.864,1.285,2.864,2.864v254.272c0,1.58-1.285,2.865-2.864,2.865h-74.729v30h74.729
    c18.121,0,32.864-14.743,32.864-32.865V32.864C458.797,14.743,444.055,0,425.934,0z"></path>
<path d="M288.339,139.998H34.068c-18.122,0-32.865,14.743-32.865,32.865v254.272C1.204,445.257,15.946,460,34.068,460h254.272
    c18.122,0,32.865-14.743,32.865-32.864V172.863C321.206,154.741,306.461,139.998,288.339,139.998z M288.341,430H34.068
    c-1.58,0-2.865-1.285-2.865-2.864V172.863c0-1.58,1.285-2.865,2.865-2.865h254.272c1.58,0,2.865,1.285,2.865,2.865v254.273h0.001
    C291.206,428.715,289.92,430,288.341,430z"></path>	
</g>
</svg></span></div></div><pre lang="cs" data-codeblock-processed="true" id="pre569483" style="margin-top: 0px;" class="notranslate"><span class="code-keyword">static</span> <span class="code-keyword">void</span> DontRepeatYourselfTryFinally(<span class="code-keyword">bool</span> createSecond) {
    First first = <span class="code-keyword">null</span>;
    Second second = <span class="code-keyword">null</span>;
    Third third = <span class="code-keyword">null</span>;
    <span class="code-keyword">try</span> {
        first = <span class="code-keyword">new</span> First();
        <span class="code-keyword">if</span> (createSecond) {
            second = <span class="code-keyword">new</span> Second(first);
            third = <span class="code-keyword">new</span> Third(second);
        } <span class="code-keyword">else</span>
            third = <span class="code-keyword">new</span> Third(first);
        third.DoSomething();
    } <span class="code-keyword">finally</span> {
        <span class="code-keyword">if</span> (third != <span class="code-keyword">null</span>) ((IDisposable)third).Dispose();
        <span class="code-keyword">if</span> (second != <span class="code-keyword">null</span>) ((IDisposable)second).Dispose();
        <span class="code-keyword">if</span> (first != <span class="code-keyword">null</span>) ((IDisposable)first).Dispose();
    } <span class="code-comment">//</span><span class="code-comment">exception
</span>} <span class="code-comment">//</span><span class="code-comment">DontRepeatYourselfTryFinally</span></pre>

<p>Is it a good solution? Well, it's pretty ugly, despite of getting rid of some repeated code. First of all, it requires type casting with all those brackets; and this is always ugly and error prone. Even more importantly, one clear benefit of <code>using</code> has gone: now we need to remember about both construction of objects and calling that <code>Dispose </code>method, which can easily be forgotten. It could be considered as better code or not, but certainly not as a good one.</p>

<h2>The Solution</h2>

<p>Let's finally admit that using just different variants of C# syntax is not enough. We need a helper class which can cover all the possible object construction patterns in a uniform manner. It does not even have to be generic, because it simply deals with types (classes, and structures as well, in boxed form) implementing the interface <code>System.IDisposable</code>. However, using its only <code>public </code>method is dramatically simplified if we make it generic. I called it <code>DisposalAccumulator</code>:</p>

<div class="pre-lang" id="premain707918"><div>C#</div><div class="pre-action-link"><span class="copy-code" data-index="707918" id="copycode707918" style="visibility: visible;"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" viewBox="0 0 460 460" style="width: 16px;height:16px;" xml:space="preserve">
<g>
<path d="M425.934,0H171.662c-18.122,0-32.864,14.743-32.864,32.864v77.134h30V32.864c0-1.579,1.285-2.864,2.864-2.864h254.272
    c1.579,0,2.864,1.285,2.864,2.864v254.272c0,1.58-1.285,2.865-2.864,2.865h-74.729v30h74.729
    c18.121,0,32.864-14.743,32.864-32.865V32.864C458.797,14.743,444.055,0,425.934,0z"></path>
<path d="M288.339,139.998H34.068c-18.122,0-32.865,14.743-32.865,32.865v254.272C1.204,445.257,15.946,460,34.068,460h254.272
    c18.122,0,32.865-14.743,32.865-32.864V172.863C321.206,154.741,306.461,139.998,288.339,139.998z M288.341,430H34.068
    c-1.58,0-2.865-1.285-2.865-2.864V172.863c0-1.58,1.285-2.865,2.865-2.865h254.272c1.58,0,2.865,1.285,2.865,2.865v254.273h0.001
    C291.206,428.715,289.92,430,288.341,430z"></path>	
</g>
</svg></span></div></div><pre lang="cs" data-codeblock-processed="true" id="pre707918" style="margin-top: 0px;" class="notranslate"><span class="code-keyword">using</span> IDisposable = System.IDisposable;
<span class="code-keyword">using</span> System.Collections.Generic;

<span class="code-keyword">public</span> <span class="code-keyword">class</span> DisposalAccumulator : IDisposable {

    <span class="code-keyword">public</span> T Add&lt;T&gt;(T element) where T : IDisposable {
        <span class="code-keyword">if</span> (element != <span class="code-keyword">null</span>)
            stack.Push(element);
        <span class="code-keyword">return</span> element;
    } <span class="code-comment">//</span><span class="code-comment">Add
</span>
    <span class="code-keyword">void</span> IDisposable.Dispose() {
        <span class="code-keyword">foreach</span> (IDisposable element <span class="code-keyword">in</span> stack)
            element.Dispose();
    } <span class="code-comment">//</span><span class="code-comment">IDisposable.Dispose
</span>
    Stack&lt;IDisposable&gt; stack = <span class="code-keyword">new</span> Stack&lt;IDisposable&gt;();

} <span class="code-comment">//</span><span class="code-comment">class DisposalAccumulator</span></pre>

<p>In essence, the class implements <code>System.IDisposable.Dispose</code> to dispose all its added elements. The <code>Stack</code> class is used to implement element storage, without extra overhead, with the most natural order of enumeration of elements used for disposal: in reverse, relative to the order of adding them.</p>

<p>Now, the usage is reduced to using of only one <code>using</code> statement, no ifs, no buts. It's used only for the instance of the <code>DisposalAccumulator</code>: </p>

<div class="pre-lang" id="premain51202"><div>C#</div><div class="pre-action-link"><span class="copy-code" data-index="51202" id="copycode51202" style="visibility: visible;"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" viewBox="0 0 460 460" style="width: 16px;height:16px;" xml:space="preserve">
<g>
<path d="M425.934,0H171.662c-18.122,0-32.864,14.743-32.864,32.864v77.134h30V32.864c0-1.579,1.285-2.864,2.864-2.864h254.272
    c1.579,0,2.864,1.285,2.864,2.864v254.272c0,1.58-1.285,2.865-2.864,2.865h-74.729v30h74.729
    c18.121,0,32.864-14.743,32.864-32.865V32.864C458.797,14.743,444.055,0,425.934,0z"></path>
<path d="M288.339,139.998H34.068c-18.122,0-32.865,14.743-32.865,32.865v254.272C1.204,445.257,15.946,460,34.068,460h254.272
    c18.122,0,32.865-14.743,32.865-32.864V172.863C321.206,154.741,306.461,139.998,288.339,139.998z M288.341,430H34.068
    c-1.58,0-2.865-1.285-2.865-2.864V172.863c0-1.58,1.285-2.865,2.865-2.865h254.272c1.58,0,2.865,1.285,2.865,2.865v254.273h0.001
    C291.206,428.715,289.92,430,288.341,430z"></path>	
</g>
</svg></span></div></div><pre lang="cs" data-codeblock-processed="true" id="pre51202" style="margin-top: 0px;" class="notranslate"><span class="code-keyword">static</span> <span class="code-keyword">void</span> DontRepeatYourself(<span class="code-keyword">bool</span> createSecond) {
    <span class="code-keyword">using</span> (DisposalAccumulator accumulator = <span class="code-keyword">new</span> DisposalAccumulator()) {
        First first = accumulator.Add(<span class="code-keyword">new</span> First());
        Third third;
        <span class="code-keyword">if</span> (createSecond) <span class="code-comment">//</span><span class="code-comment">no need to create a variable "second"
</span>            third = accumulator.Add(<span class="code-keyword">new</span> Third(accumulator.Add(<span class="code-keyword">new</span> Second(first))));
        <span class="code-keyword">else</span>
            third = accumulator.Add(<span class="code-keyword">new</span> Third(first));
        third.DoSomething();
    } <span class="code-comment">//</span><span class="code-comment">everything is disposed
</span>} <span class="code-comment">//</span><span class="code-comment">DontRepeatYourself </span></pre>

<p>Note the value of the generic <code>Add</code> method with the pass-through input parameter. Interestingly, <a title="Type inference" href="http://en.wikipedia.org/wiki/Type_inference"><em>type inference</em></a> (available in .NET v.3.5 and later) allows not to instantiate this generic method with <code>Add</code>, as the compiler can figure out the required generic parameter from the compile-time type of a variable on the left of the assignment operator. It makes the usage especially smooth.</p>

<p>One may argue that the call to <code>DisposalAccumulator.Add</code> can easily be forgotten for some of the variables. My answer would be: that is not more likely than forgetting of using one of <code>using</code> statements; it usually happens when a developers fails to see that some library type implements <code>System.IDisposable</code>.</p>

<h2>Conclusion </h2>

<p>Overall, the nesting <code>using</code> statements, even without a run-time condition affecting their structures could be used if the number of disposable objects is reasonably small. In all other cases, using the <code>DisposalAccumulator</code> or a similar helper would be quite beneficial.</p>

<h2>Credits</h2>

<p>Of course, I appreciate inventiveness, the thirst for perfection, openness and collaborative attitudes of <a href="http://www.codeproject.com/Members/Mika-Wendelius">Mika Wendelius</a> who caused me to get a very fresh look at the problem.</p>

<p><a href="http://www.codeproject.com/Members/Andreas-Gieriet">Andreas Gieriet</a> found a bug in the last code fragment, usage sample. I fixed it. Thank you very much, Andi!</p>

<p><a href="http://www.codeproject.com/Members/robert_schutt">Robert Schutt</a> advised an improvement to the code sample of <code>DontRepeatYourselfTryFinally</code> — thank you very much, Robert! </p>



<!-- Article Ends -->


						</div>
						

						
						<h2>License</h2>
						<div id="LicenseTerms"><p>This article has no explicit license attached to it but may contain usage terms in the article text or the download files themselves. If in doubt please contact the author via the discussion board below.</p><p>A list of licenses authors might use can be found <a href="https://www.codeproject.com/info/Licenses.aspx">here</a></p></div>
						

						
						<br>
						
						    <br>
						
						

						<div class="clearfix"></div>

						<div style="padding-top:8px">
							
						</div>

					

				    
					</form>

				</div>

				
				<div class="bottom-promo"> 
				    
				</div>
				
                
                

				
				
				

			</div>
			

            
            
            

        </div>
        

		
		<div class="site-footer">
			<div class="align-left">
				<a id="ctl00_PermaLink" href="https://www.codeproject.com/Articles/458846/Using-using-Statements-DisposalAccumulator">Permalink</a><br>
				<br>
				<a id="ctl00_PrivacyLink" href="https://www.codeproject.com/info/privacy.aspx">Privacy</a><br>
    			<a id="ctl00_CookiePolicyLink" href="https://www.codeproject.com/info/cookie.aspx">Cookies</a><br>
                <a id="ctl00_TermsOfUseLink" href="https://www.codeproject.com/info/TermsOfUse.aspx">Terms of Use</a><br>
			</div>

            <div class="align-center">
				


<div class="page-width">
    Layout: <a id="ctl00_PageWidth_FixedT" title="Fixed width layout" rel="nofollow" class=" active" href="https://www.codeproject.com/Tips/458846/Using-using-Statements-DisposalAccumulator?PageFlow=FixedWidth">fixed</a>
    |
    <a id="ctl00_PageWidth_FluidT" title="Fluid layout" rel="nofollow" href="https://www.codeproject.com/Tips/458846/Using-using-Statements-DisposalAccumulator?PageFlow=Fluid">fluid</a>
</div>


				

				

	            

                <br>
			</div>
                
			<div class="align-right">
				Article Copyright 2012 by Sergey Alexandrovich Kryukov<br>Everything else
				Copyright © <a href="mailto:webmaster@codeproject.com">CodeProject</a>, 1999-2024<br>
                <br>
				Web01 
				2.8:2024-12-08:1<br>
			</div>
		</div>
		

		<br clear="all">
		
			

	</div> 
	</div> 
</div>







<script type="text/javascript"> // DEFERRED script

document.addEventListener('DOMContentLoaded', function() {

	new CodeBlocks().initialise('#contentdiv');
	
	$('.author-wrapper .description').shorten({showChars: 400});
	
	anchorAnimate();
	
	$('#__EVENTVALIDATION').attr('autocomplete', 'off');

})
</script>










<style type="text/css">.copied::after {  position: absolute;  right: 0;  display: inline-block; white-space: nowrap; content: 'copied'; color: #fff; background-color: #f90;  border-radius: 3px; padding:1px 8px; opacity: 0;  will-change: opacity, transform; animation: showcopied 1.5s ease; } @keyframes showcopied { 0% { opacity: 0; } 70% { opacity: 1; } 100% { opacity: 0; } } </style><canvas id="cv1" width="1px" height="1px" style="position:absolute;left:0;top:0;pointer-events:none"></canvas><canvas id="cv2" width="1px" height="1px" style="position:absolute;left:0;top:0;pointer-events:none"></canvas></body><grammarly-desktop-integration data-grammarly-shadow-root="true"><template shadowrootmode="open"><style>
      div.grammarly-desktop-integration {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
        -moz-user-select: none;
        -webkit-user-select: none;
        -ms-user-select:none;
        user-select:none;
      }

      div.grammarly-desktop-integration:before {
        content: attr(data-content);
      }
    </style><div aria-label="grammarly-integration" role="group" tabindex="-1" class="grammarly-desktop-integration" data-content="{&quot;mode&quot;:&quot;full&quot;,&quot;isActive&quot;:true,&quot;isUserDisabled&quot;:false}"></div></template></grammarly-desktop-integration></html>