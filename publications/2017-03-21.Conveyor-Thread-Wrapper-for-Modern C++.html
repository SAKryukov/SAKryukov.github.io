<!DOCTYPE html>
<!-- saved from url=(0072)https://www.codeproject.com/Articles/1177869/Conveyor-Thread-Wrapper-CPP -->
<html lang="en" data-lt-installed="true"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

	
	<link rel="preconnect" href="https://www.google-analytics.com/">

	<link rel="preconnect" href="https://www.codeproject.com/">


	<link rel="preload" href="./Resources/logo250x135.gif" as="image">


	<link rel="preload" href="https://www.codeproject.com/App_Themes/CodeProject/Img/logo135-bg.gif" as="image">
	<link rel="preload" href="./Resources/jquery-3.4.1.min.js.download" as="script" type="text/javascript">


	<title>Conveyor Thread Wrapper for Modern C++- CodeProject</title> 
    
        <style>
            @import url(./Resources/Article.min.css);
            @import url(./code/epigraph.css);
        </style>

    <script type="text/javascript" async="" src="./Resources/analytics.js.download"></script><script type="text/javascript" src="./Resources/jquery-3.4.1.min.js.download" defer=""></script>
<script type="text/javascript" src="./Resources/article.min.js.download" defer=""></script>

	
<meta http-equiv="content-language" content="en-US">

<meta name="Description" content="New thread wrapper (v. 2.0) offers programming model based on blocking queue and delegates supplied by other threads">
<meta name="Keywords" content="C++, C#, Visual-Studio, Intermediate, Advanced, VS2013">
<meta name="Author" content="Sergey Alexandrovich Kryukov">
<meta name="Rating" content="General">
<meta name="Revisit-After" content="1 days">
<meta name="application-name" content="CodeProject">
<meta name="google-translate-customization" content="d908bb7ce7aff658-4c2f3a504525c916-g629383f736781a8a-13">



<link rel="dns-prefetch" href="https://ajax.googleapis.com/"> 
<link rel="canonical" href="https://www.codeproject.com/Articles/1177869/Conveyor-Thread-Wrapper-for-Modern-Cplusplus">
<meta name="twitter:card" content="summary">
<meta name="twitter:site" content="@CodeProject">
<meta name="og:site_name" content="CodeProject">
<meta name="twitter:creator" content="@CodeProject">
<meta property="og:type" content="article">
<meta property="article:published_time" content="3/21/2017 6:50:00 PM">
<meta property="article:modified_time" content="10/29/2017 3:50:00 PM">
<meta name="twitter:label1" content="Written by">
<meta name="twitter:data1" content="Sergey Alexandrovich Kryukov">
<meta name="twitter:label2" content="Reading time">
<meta name="twitter:data2" content="13 min read">
<meta property="og:url" content="https://www.codeproject.com/Articles/1177869/Conveyor-Thread-Wrapper-for-Modern-Cplusplus">
<meta property="og:title" content="Conveyor Thread Wrapper for Modern C++">
<meta property="og:description" content="New thread wrapper (v. 2.0) offers programming model based on blocking queue and delegates supplied by other threads">


<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="apple-touch-icon" sizes="144x144" href="https://www.codeproject.com/favicon/apple-touch-icon.png"> 
<link rel="icon" type="image/png" sizes="32x32" href="https://www.codeproject.com/favicon/favicon-32x32.png"> 
<link rel="icon" type="image/png" sizes="16x16" href="https://www.codeproject.com/favicon/favicon-16x16.png"> 
<link rel="manifest" href="https://www.codeproject.com/favicon/manifest.json"> 
<link rel="mask-icon" href="https://www.codeproject.com/favicon/safari-pinned-tab.svg" color="#ff9900">
	<script type="application/ld+json">{
  "@context": "http://schema.org",
  "@type": "TechArticle",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://www.codeproject.com/Articles/1177869/Conveyor-Thread-Wrapper-for-Modern-Cplusplus"
   },
  "name": "Conveyor Thread Wrapper for Modern C++",
  "headline": "Conveyor Thread Wrapper for Modern C++",
  "url": "https://www.codeproject.com/Articles/1177869/Conveyor-Thread-Wrapper-for-Modern-Cplusplus",
  "discussionUrl": "https://www.codeproject.com/Articles/1177869/Conveyor-Thread-Wrapper-for-Modern-Cplusplus#_comments",
  "isFamilyFriendly": "true",
  "image": "https://www.codeproject.com/App_Themes/CodeProject/Img/Article100.png",
  "keywords": "C++,C#,Visual-Studio,Intermediate,Advanced,VS2013",
  "commentCount": "0",
  "editor" : {
    "@type" : "Person",
    "name" : "Editor",
    "url" : "https://www.codeproject.com/script/Membership/View.aspx?mid=2291164"
  },
  "license": "http://www.codeproject.com/info/cpol10.aspx",
  "publisher" : {
    "@type" : "Organization",
    "name" : "CodeProject"
  },
  "description": "New thread wrapper (v. 2.0) offers programming model based on blocking queue and delegates supplied by other threads",
  "articleSection": "C#",
  "author" : [{
      "@type" : "Person",
      "name" : "Sergey Alexandrovich Kryukov",
      "url" : "https://www.codeproject.com/script/Membership/View.aspx?mid=2291164"
    }],
  "datePublished": "2017-03-21",
  "dateCreated": "2017-03-21",
  "dateModified": "2017-10-29"
,
  "contentRating" : {
    "@type" : "Rating",
    "ratingValue" : 4.99,
    "bestRating" : 5,
    "worstRating" : 1
  }
}</script>

<script type="application/ld+json">{
  "@context": "http://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [{
    "@type": "ListItem",
    "position": 1,
    "item" : {
      "@id" : "/script/Content/Tag.aspx?tags=Languages",
      "name" : "Languages"
    }
  },{
    "@type": "ListItem",
    "position": 2,
    "item" : {
      "@id" : "/script/Content/Tag.aspx?tags=Csharp",
      "name" : "C#"
    }
  }]
}</script>

<script type="text/javascript">
function defrm () { /* thanks twitter */
    document.write = '';
    window.top.location = window.self.location;
    setTimeout(function() { document.body.innerHTML = ''; }, 0);
    window.self.onload = function(evt) { document.body.innerHTML = ''; };
}

if (window.top !== window.self) {
    try {
        if (window.top.location.host) { /* will throw for all except chrome */ }
        else { defrm(); /* chrome */ }
    } catch (ex) { defrm(); /* everyone else */ }
}

// Specific case where a site is screwing with us.
if (typeof(DemoUrl) !== 'undefined') {
    document.write(unescape('%3Cme') + 'ta http' + '-equiv="re' + 'fresh con' +
                           'tent="1;url=' + DemoUrl + unescape('"%3CE'));
}
</script>
	





    <script async="" type="text/javascript" src="./Resources/js"></script>
    <script type="text/javascript">
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'UA-1735123-1' , {'user_id': '42a7d533-9829-4f88-8fc6-84dc936250c9'});
    </script>

<style type="text/css"></style></head>	

<body class="chrome chrome120" data-new-gr-c-s-check-loaded="14.1215.0" data-gr-ext-installed="">



<a class="access-link" href="#Main"><img alt="Click here to Skip to main content" src="./Resources/t.gif"></a>




<div class="page-background">

	
	

	

	
    <div id="ctl00_STM" class="site-top-menu fixed narrow">
        <div class="main-content">
            

<div class="container memberbar clearfix flex-container flex-extend">

	<div id="ctl00_MemberBar_GenInfo" class="flex-item align-left">65,938 articles</div>
	
	<div id="ctl00_MemberBar_ChangeNotice" class="flex-item align-left">CodeProject
	is changing. <a href="https://www.codeproject.com/info/Changes.aspx">Read more</a>.</div>

	<div class="flex-item">
		
	</div>

	<div class="flex-item align-right">

		

		

		
	</div>
</div>
        </div>
    </div>

	
    <div id="ctl00_SH" class="site-header fixed narrow">
        <div class="main-content">
            <div class="logo"><a href="https://www.codeproject.com/"><img id="ctl00_Logo" tabindex="1" title="CodeProject" src="./Resources/logo250x135.gif" alt="Home" style="height:135px;width:250px;border-width:0px;"></a></div>
            <div class="promo"></div>
        </div>
    </div>

	
			
	

	<div id="A" class="container-content-wrap fixed narrow"> 

	<div class="container-content">

        
		<div class="clearfix">
			<div class="container-breadcrumb float-left ">
				<div><a rel="nofollow" href="https://www.codeproject.com/script/Content/SiteMap.aspx">Articles</a> / <a rel="nofollow" href="https://www.codeproject.com/script/Content/Tag.aspx?tags=Languages">Languages</a> / <a rel="nofollow" href="https://www.codeproject.com/script/Content/Tag.aspx?tags=Csharp">C#</a></div>
			</div>

            <div class="float-left">
				
			</div>

			<div class="edit-links float-right">
				



 
&nbsp;










			</div>

			<div class="article-nav float-right">
				


<div style="display:inline-block;position:relative;top:-6px;margin-right:20px">
    
</div>



 

<a id="ctl00_ActionLinks_PrintMd" data-tooltip="Print" data-enabletooltip="true" data-width="auto" href="https://www.codeproject.com/Articles/1177869/Conveyor-Thread-Wrapper-for-Modern-Cplusplus?display=Print" class="tooltip" title="">
   <img src="./Resources/print48.png" width="24" height="24" style="border:0">
<div class="speech-bubble-container-up" style="width:auto">  <div class="speech-bubble-up" style="text-align:center"> Print</div>  <div class="speech-bubble-pointer-up">    <div class="speech-bubble-pointer-up-inner"></div>  </div></div></a>



<span id="ctl00_ActionLinks_R">
    
    
</span>
			</div>
		</div>

        
		<div class="extended article-container-parts">

			
		    
            

			
			<div id="AT" class="article-container  fixed narrow" style="max-width:inherit;"> 

				<div class="article">

					<form name="aspnetForm" method="post" action="https://www.codeproject.com/Articles/1177869/View.aspx" id="aspnetForm" style="margin:0;padding:0">
<div>
<input type="hidden" name="__VIEWSTATE" id="__VIEWSTATE" value="6dG1pvKQBLoqmKPPYShTlvqDlJUB3J1fUsViHn/9U72yXLQklu6GxwZDsORTaholvEvKPnY58VbITBbrtfd5mCd1d1DQjrKNR2gL8mxRPg6pAfnNGFeCufuvUZ8sFfB8j5miuvBIc79dh+DuquGbO3krTW8gcVH4V52xdg3SunLLc4pGa12ux1MY+sIp/jWAv4w4H3hRRo2u8mwLf0s05eLYI2ax0DPqJkW2ZTVpOHCSlvZnUR5e0whAxVBHZIO2kImKvnRXijuyI0h83lhgNi1YbN9oTPaRM44p3IKT2ofdqIrA5JAP/7V1iTN7xGpKvla9RHHNkBJ1bIW4nu+vmnR5YX+kbJ2Nm75z0AcodQ6fwTI2cL2ygQDwVUWO8j/DVzoUiQ3Tr0uPjuZzHArykHcXrZfwRILsABZIOPsnBPj++4jfemPvPSPlxSM2Xwl6D4NEsVG+JD99YCatg7zQLJfuKy7PtwwXdjnPaPe2AvfzTGwI/bKNOw9fZgSfnK5GAjNv+jmPcYObDQuOA6WloZB3SYTsj1+4+ggMh/TEg5zQJDg9ASiFWP3DtyIeYVjLySuao/MZFYVO5VyRh/YbwAqV9MHXnhFnMdH5qUttfujtYf1+3eUaJdf4PYb/+CwdMhkzDTaDhOJNz4v3BoFQvtkmOvG+iFK3Gehcm9M0QZP1shAb4oxeKrIcbPxsJbZtdFtNnKGS1+QPkUdNgusugFxzaGFt774UDqPbxQpFnpnjHVZAOD7sz1DtRMzBoPgg3qukpNxF36z1KyS6PQuTx+3g2GTxn1GD5b5VlXhNWfXvskGcWcRvnPZA6V12XZT5j19slCWpGu7qM2vcjqC1uZ6k6Euu3SJz/ij3U0x+vAHsyFW/TPjwPMBXqQeVqKpUxE8Ka5Pg+00NzzgscbpBUubP2H/w4Gy2ID+y8ywx5EMPmEWC+T1lk3P+4Sbd+S0Wp0uvjNZy/ej7OqgMUQVKFhQ2W0jkZfVsFU9QCiuaWeEhYvoC6H5X1AwWho5+dX/LYYvQPrytSW5G1zo9sroeOwaY8pjbsoyulA6YxDonJDDGxXsZOaUuxySPY4dlH+eKzd1kUaTnCY69Ork182oESCDe2dMZ9Q5IkT/p8vghXlcov76pB9/5braNR7WOJ7hNuAN3878krFUZ/+kUTNAqHjukagVPYG8YNK2e0GcGKYuIf+vz2hHRx1/o4kJF9lMgAIcH7bAj1XMiLVDgrSS6Ty9v96WVqlKsg0UR93BEt8jh6HKYGf5l3vIYgSFe2UiDJYvwwJCeLFT2fPGYIEvNwK7lTGajeUuL8OhRBf9/PxMmZ3/VXsHfsK4+eOS3EzH80a9FliX3vS29HOlaFuopujg9lcDDcmIFKXwUVOn6O6Drh6DVfaEw7bYTdkS42gdO1SfapJ0gftiZ8UT33kTuda4wiv7d+wNZ1T+FdIDISvG9aiGiEvUJExGkKMZ7EdQv5q8UeY8/a1ltol2OV0rLJnQLwk6eeqKm9rjyJst1Elk++OQhoszyEvKgbWAY7aOZMCD8kjszlkyyaEOMxoAziGjbBCqkfcutwqS5ASVPUdGwfyh8yn4pEvHLmt8zhjg6dYXi1ITmyuaVdQDhydeO0Ene/82FB5Sv72PljDumEX4Svb74uqoV+74tdVzl5DNEG9l9D4cOjm/9Ul4SyCFNhEjqU33/zUo13lZDrwfj402PV/AQtrGRdjajU54gF9gRxKmYVyJPyUcCepgKLgOtv7pahwkR7pP1qFVFqm5VdM2HA9SHwg4THyIUToKCIbXdqq+adSegYetDN9aV55VAkfxS9CQI/sv2An5868c83zWO20+epkFIcSbPGLk1xwMGv+bw2P21UVCdHiKwFjHNnjd0nNI8f2AUAMyt7DVm5+L8E7m2kWXoMPNbU0PQCf2RMEEQdKXLNoYQQORmwJNBmdObz0zPShhfPQxrGOYtSEwQ8ygtjeTLRqSu2N+itHgJ4lu/VnAEspWVKsclJbXifWtSpXTJLacR4Fv/jmf0uKqTCKUWnuIWOHFGiRqCgW/AfyLK4EbU6HcRN13jshS2rsKlpwchaMlf7fzZup2ZhoiyUXAlVhhFfIZt3A1xtrlSfDY3xvlJ9PMsdkT6LKanLovHE1ydcb3QY0qv28k//FyQTmFKf5hwuD6qhAqFHV5rsmxEEA==">
</div>

<div>

	<input type="hidden" name="__VIEWSTATEGENERATOR" id="__VIEWSTATEGENERATOR" value="10C1FD69">
</div>

					
					 
					<div class="header">
					    <a name="Main"></a>
					    <a name="_articleTop" id="_articleTop"></a>

					    
						<div>
							<span id="ctl00_TagListHorz_TagWrp" class="tags horizontal">

	
	

	
	<span id="ctl00_TagListHorz_VisibleTags"><div class="t"><a rel="tag" href="https://www.codeproject.com/Tags/Cplusplus" data-id="78">C++</a></div><div class="t"><a rel="tag" href="https://www.codeproject.com/Tags/Csharp" data-id="81">C#</a></div><div class="t"><a rel="tag" href="https://www.codeproject.com/Tags/Visual-Studio" data-id="103">Visual-Studio</a></div><div class="t"><a rel="tag" href="https://www.codeproject.com/Tags/VS2013" data-id="2768">VS2013</a></div></span> 

	
	
</span>


						</div>
					    <div class="title">
					        <h1 id="ctl00_ArticleTitle">Conveyor Thread Wrapper for Modern C++</h1>
					    </div>

                        <div>
					        
					        <div class="entry flex-container">

								

                                <div class="flex-item" style="flex:1 1 auto">
                                    <div class="flex-container" style="justify-content:space-between;flex-wrap:wrap-reverse">
                                       <span id="ctl00_Authors" class="author flex-item"><a href="https://www.codeproject.com/script/Membership/View.aspx?mid=2291164" rel="author">Sergey Alexandrovich Kryukov</a></span> 

                                        <div class="flex-item" style="margin-top:-4px;">
                                            <div id="ctl00_RateArticle_RatingTable" class="small-text" data-objectref="2_1177869">

	<meta itemprop="upvoteCount" content="24">


	<div id="ctl00_RateArticle_RatingRow" class="flex-container rating-container large-stars">

					
		

		
		<div class="nowrap tooltip">

			
			<div id="ctl00_RateArticle_ResultNoHist" class="rating-result"><div class="flex-container rating-stars large-stars"><div><img src="./Resources/star-fill-lg.png" style="width:24px;height:24px"></div><div><img src="./Resources/star-fill-lg.png" style="width:24px;height:24px"></div><div><img src="./Resources/star-fill-lg.png" style="width:24px;height:24px"></div><div><img src="./Resources/star-fill-lg.png" style="width:24px;height:24px"></div><div style="width:23px;" class="clipped"><img src="./Resources/star-fill-lg.png" style="width:24px;height:24px"></div><div style="width:1px;position:relative" class="clipped"><img src="./Resources/star-empty-lg.png" style="width:24px;height:24px;position:absolute;top:0px;right:0"></div></div></div>
			

			
			

			
            

			
                

		</div>
		
	
		
		<div id="ctl00_RateArticle_VoteCountNoHist" class="rating-votes nowrap">4.99/5  (25 votes)</div>	

		

		
		<div class="rating-undo" title="Undo vote" style="margin-left:5px;display:none"></div>

		
		
	</div>

	
	

</div>

                                        </div>
                                    </div>

                                    <div class="flex-container" style="color:#666;font-size:smaller">
                                        <span id="ctl00_LastUpdated" class="date flex-item-tight" title="Date last updated">21 Mar 2017, last revision: 29 Oct 2017</span><a id="ctl00_LicenseLink" title="The Code Project Open License (CPOL)" class="license flex-item-tight" href="http://www.codeproject.com/info/cpol10.aspx">CPOL</a><span id="ctl00_ReadingTime" class="stats flex-item-tight">13 min read</span><span id="ctl00_HorizontalStats" class="stats flex-item-tight"><span class="stats"><span title="Views"><img src="./Resources/views32.png" style="width:16px"> 27.9K</span> &nbsp; <span title="Downloads"><img src="./Resources/download32.webp" style="width:16px"> 542</span> &nbsp; </span></span>
                                    </div>
                                </div>
					        </div>

                            

                        </div>

                        <div id="ctl00_DescriptionSpot" class="summary">New thread wrapper (v. 2.0) offers programming model based on blocking queue and delegates supplied by other threads</div><span id="ctl00_ThumbnailUrl" class="date" content="https://www.codeproject.com/script/Articles/Images/article100x80.png"></span>			

                    </div>
                    
					
					

					

					
					

					
					

						
					

					

						
						<div id="contentdiv" class="text">
						



<!-- Article Starts -->

<ul class="download">
	<li><a href="Conveyor-Thread-Wrapper-for-Modern C++.zip">Download source code — 16.3 KB</a></li></ul>

<p class="epigraph">Epigraph:<br/>
<br/>
<em>In the queue, you sons of bitches, in line!</em><br/>
<strong><a href="https://en.wikipedia.org/wiki/Mikhail_Bulgakov">M. A. Bulgakov</a>, <a href="https://en.wikipedia.org/wiki/Heart_of_a_Dog"><i>Heart of a Dog</i></a></strong>
</p>

<h2>Contents</h2>

<div id="TOC">
<ul style="list-style-type: none; list-style-image: initial">
	<li><a href="#introduction">Introduction</a></li>	<li><a href="#thread-wrapper-design">Thread Wrapper Design</a></li>	<li><a href="#demonstration">Demonstration</a></li>	<li><a href="#demonstrated-algorithms">Demonstrated Algorithms</a></li>	<li><a href="#giving-the-wrapper-a-task">Giving the Wrapper a Task</a></li>	<li><a href="#queue-synchronization">Queue Synchronization</a></li>	<li><a href="#thread-state-synchronization">Thread State Synchronization</a></li>	<li><a href="#handling-shallow-abort">Handling Shallow Abort</a></li>	<li><a href="#delegate-and-delegate-parameter-types">Delegate and Delegate Parameter Types</a></li>	<li><a href="#compatibility-and-build">Compatibility and Build</a></li>	<li><a href="#versions">Versions</a></li>	<li><a href="#conclusions">Conclusions</a></li></ul>
</div>

<h2 id="introduction">Introduction</h2>

<p>This is the second article from the short series devoted to thread wrappers:</p>

<ol>
	<li><a href="https://www.codeproject.com/Articles/1177478/Thread-Wrapper-CPP"><em>Thread Wrapper for Modern C++</em></a>.</li>	<li>Present article.</li></ol>

<p>This new article combines several things.</p>

<p>First of all, new conveyer wrapper is based on the <a href="https://www.codeproject.com/Articles/1177478/Thread-Wrapper-CPP">previous article</a> where most principles of threading and thread synchronization are described in detail. I’ll have to point to this article in several places.</p>

<p>Next important component is the design and implementation of <em>delegates</em> taken from my article <a href="https://www.codeproject.com/Articles/1170503/The-Impossibly-Fast-Cplusplus-Delegates-Fixed"><em>The Impossibly Fast C++ Delegates, Fixed</em></a>. These delegates are faster than <code>std::function</code> and offer considerable convenience.</p>

<p>And, finally, this is all combined with the conception of <em>blocking <a href="#epigraph">queue</a></em> or <em>blocking collection</em>. One well-known example of such is the <a href="https://en.wikipedia.org/wiki/Framework_Class_Library">.NET FCL</a> template class <a href="https://www.codeproject.com/Articles/1170503/The-Impossibly-Fast-Cplusplus-Delegates-Fixed"><code>BlockingCollection</code></a>. In my article <a href="https://www.codeproject.com/Tips/149540/Simple-Blocking-Queue-for-Thread-Communication-and"><em>Simple Blocking Queue for Thread Communication and Inter-thread Invocation</em></a>, I offered my implementation of the blocking queue (this work originated from .NET v.3.5, where <a href="https://www.codeproject.com/Articles/1170503/The-Impossibly-Fast-Cplusplus-Delegates-Fixed"><code>BlockingCollection</code></a> wasn’t yet introduced) and demonstrated various interesting use cases, including the one relevant to the present topic.</p>

<p>Such queues are a part of some very widely used programming models, such as <a href="https://en.wikipedia.org/wiki/Message_queue">message queues</a>. It is very typical that one thread supplies data, pushing them into a queue, which is usually not a blocking call; and another thread is receiving them from a queue, which is usually a blocking call used to put a thread in the wait state when a queue is empty. Multiple threads can participate in this transport on both ends.</p>

<p>The topic of this article is the specialized case of the queue, <a href="https://www.codeproject.com/Tips/149540/Simple-Blocking-Queue-for-Thread-Communication-and">explained in my article on the blocking queues</a>. Do the queue elements have to be just data? No. One important approach is to <a href="#epigraph">queue… the delegate instances</a>. More exactly, a queue element could be a delegate instance packed with the values of the parameters needed for the delegate calls.</p>

<p>This is the way to defer execution of several tasks and serialize the execution. There is nothing wrong which consecutive execution of some tasks, just the opposite, using to many or unpredictable number of threads is a pretty usual mistake. Still, parallelism is used; and the set of the queued tasks is executed in parallel with some other threads, such as UI.</p>

<p>This approach covers a big and practically important class of applications. It’s very typical that we need to queue one or more tasks for background execution while doing other activities, such as UI operation, networking, communications, etc., in other threads. It’s also the best to reuse the same thread during the whole application lifetime, instead of creating a thread again and again for every execution of a background task. It could be considered as a more stable and predictable alternative to <em>thread pools</em>.</p>

<h2 id="thread-wrapper-design">Thread Wrapper Design</h2>

<p>The method <code>Body</code> of the class <code>ConveyorThreadWrapper</code> is <a href="#handling-shallow-abort">sealed</a> by using the <code>final</code> <em>specifier</em>. The control over the code to be executed in a thread is given to the user in a different form: the user can supply different delegates and push them onto the queue. I will refer the actions performed by such delegate instances to as <em><strong>tasks</strong></em>. The class is a template class; its only template parameter is the type of the delegate parameter. To queue a task, the use code supplies a delegate instance and a value of a parameter for the its call.</p>

<p>This wrapper class can be used immediately, without a need to create derived classes. Apparently, the delegates can be based on the member functions of such derived class, but it’s more natural to make them based on some user class. See also the section <a href="#delegate-and-delegate-parameter-types">Delegate and Delegate Parameter Types</a>.</p>

<p>The only thing to override would be the virtual function <code>OnCurrentTaskAborted</code>, but even this is not needed; instead, since <a href="#section-1">v.&nbsp;2.0</a>, another delegate <code>CurrentTaskAborted</code> can be supplied by the user code for the same purpose.</p>

<p>The user code can request abort on two different levels: <em>shallow</em> and <em>deep</em>. Deep abort is propagated to the to stack frame of the thread, so the whole thread is terminated, but shallow abort is propagated only to the end of the currently executing task; after this abort, the thread takes another task from the queue, which leads either to the wait state (if the queue is empty) or immediate execution of the next task.</p>

<h2 id="demonstration">Demonstration</h2>

<p>To see how it all works, let’s look at the demonstration. Presently, there are two demonstrations shown one after another; first one is the modified presentation <a href="https://www.codeproject.com/Articles/1177478/Thread-Wrapper-CPP">for the first article</a>. Let’s look at the second one.</p>

<p>There are two different delegate instances implementing two <a href="#demonstrated-algorithms">different algorithms</a>. The user is supposed to enter just one character at a time as a command, a character followed by [Enter]. Depending on the character, the thread can be put to sleep, waken up or aborted. The user can choose the either the <em>deep abort</em> (quit) or <em>shallow abort</em>, which aborts the presently executing task. For other characters, the code point of the entered character is passed to the delegate as its parameter of the type used as a template parameter type. To handle the shallow abortion, the class derived from <code>ConveyorThreadWrapper</code> is written:</p>

<div id="integerConveyor">
<div class="pre-lang" id="premain446437"><div>C++</div><div class="pre-action-link"><span id="copycode446437" class="copy-code" data-index="446437" style="visibility: visible;"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" viewBox="0 0 460 460" style="width: 16px;height:16px;" xml:space="preserve"><g><path d="M425.934,0H171.662c-18.122,0-32.864,14.743-32.864,32.864v77.134h30V32.864c0-1.579,1.285-2.864,2.864-2.864h254.272     c1.579,0,2.864,1.285,2.864,2.864v254.272c0,1.58-1.285,2.865-2.864,2.865h-74.729v30h74.729 c18.121,0,32.864-14.743,32.864-32.865V32.864C458.797,14.743,444.055,0,425.934,0z"></path><path d="M288.339,139.998H34.068c-18.122,0-32.865,14.743-32.865,32.865v254.272C1.204,445.257,15.946,460,34.068,460h254.272 c18.122,0,32.865-14.743,32.865-32.864V172.863C321.206,154.741,306.461,139.998,288.339,139.998z M288.341,430H34.068    c-1.58,0-2.865-1.285-2.865-2.864V172.863c0-1.58,1.285-2.865,2.865-2.865h254.272c1.58,0,2.865,1.285,2.865,2.865v254.273h0.001 C291.206,428.715,289.92,430,288.341,430z"></path></g></svg></span></div></div>
<pre id="pre446437" style="margin-top:0;" class="lang-cplusplus notranslate" data-language="c++" data-allowshrink="True" data-collapse="False" data-codeblock-processed="true"><span class="code-keyword">class</span> IntegerConveyor : <span class="code-keyword">public</span> ConveyorThreadWrapper<span class="code-keyword">&lt;</span><span class="code-keyword">int</span><span class="code-keyword">&gt;</span> {
protected:
    <span class="code-keyword">virtual</span> <span class="code-keyword">void</span> OnCurrentTaskAborted(<span class="code-keyword">const</span> int&amp; current) <span class="code-keyword">override</span> {
        <span class="code-sdkkeyword">std::cout</span> <span class="code-keyword">&lt;</span><span class="code-keyword">&lt;</span> <span class="code-string">"</span><span class="code-string">Current task aborted: "</span> <span class="code-keyword">&lt;</span><span class="code-keyword">&lt;</span> current;
        ConveyorThreadWrapper<span class="code-keyword">&lt;</span><span class="code-keyword">int</span><span class="code-keyword">&gt;</span>::OnCurrentTaskAborted(current);
    } <span class="code-comment">//OnCurrentTaskAborted
</span>}; <span class="code-comment">//class IntegerConveyor</span></pre>

<p>Note the call to the method of the base class <code>OnCurrentTaskAborted</code>. Normally, this is not intended. The only reason I do it is to demonstrate the operation of the delegate <code>CurrentTaskAborted</code>, which could not be called without the base class’s method:</p>

<div id="integerConveyor">
<div class="pre-lang" id="premain675190"><div>C++</div><div class="pre-action-link"><span id="copycode675190" class="copy-code" data-index="675190" style="visibility: visible;"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" viewBox="0 0 460 460" style="width: 16px;height:16px;" xml:space="preserve"><g><path d="M425.934,0H171.662c-18.122,0-32.864,14.743-32.864,32.864v77.134h30V32.864c0-1.579,1.285-2.864,2.864-2.864h254.272     c1.579,0,2.864,1.285,2.864,2.864v254.272c0,1.58-1.285,2.865-2.864,2.865h-74.729v30h74.729 c18.121,0,32.864-14.743,32.864-32.865V32.864C458.797,14.743,444.055,0,425.934,0z"></path><path d="M288.339,139.998H34.068c-18.122,0-32.865,14.743-32.865,32.865v254.272C1.204,445.257,15.946,460,34.068,460h254.272 c18.122,0,32.865-14.743,32.865-32.864V172.863C321.206,154.741,306.461,139.998,288.339,139.998z M288.341,430H34.068    c-1.58,0-2.865-1.285-2.865-2.864V172.863c0-1.58,1.285-2.865,2.865-2.865h254.272c1.58,0,2.865,1.285,2.865,2.865v254.273h0.001 C291.206,428.715,289.92,430,288.341,430z"></path></g></svg></span></div></div>
<pre id="pre675190" style="margin-top:0;" class="lang-cplusplus notranslate" data-language="c++" data-allowshrink="True" data-collapse="False" data-codeblock-processed="true">cv.CurrentTaskAborted = [](<span class="code-keyword">int</span>) -<span class="code-keyword">&gt;</span> <span class="code-keyword">void</span> {
    <span class="code-sdkkeyword">std::cout</span> <span class="code-keyword">&lt;</span><span class="code-keyword">&lt;</span> <span class="code-string">"</span><span class="code-string">. Enter any character: "</span>;
}; <span class="code-comment">//cv.CurrentTaskAborted</span></pre>

<p>See also the <a href="#conveyorThreadWrapperDemo">complete demo</a>.</p>

<p>This wrapper and its embedded thread are driven from a main thread from a console:</p>

<div id="conveyorThreadWrapperDemo">
<div class="pre-lang" id="premain448830"><div>C++</div><div class="pre-action-link"><span class="code-collapse" data-index="448830" id="preShrink448830">Shrink ▲</span> &nbsp; <span id="copycode448830" class="copy-code" data-index="448830" style="visibility: visible;"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" viewBox="0 0 460 460" style="width: 16px;height:16px;" xml:space="preserve"><g><path d="M425.934,0H171.662c-18.122,0-32.864,14.743-32.864,32.864v77.134h30V32.864c0-1.579,1.285-2.864,2.864-2.864h254.272     c1.579,0,2.864,1.285,2.864,2.864v254.272c0,1.58-1.285,2.865-2.864,2.865h-74.729v30h74.729 c18.121,0,32.864-14.743,32.864-32.865V32.864C458.797,14.743,444.055,0,425.934,0z"></path><path d="M288.339,139.998H34.068c-18.122,0-32.865,14.743-32.865,32.865v254.272C1.204,445.257,15.946,460,34.068,460h254.272 c18.122,0,32.865-14.743,32.865-32.864V172.863C321.206,154.741,306.461,139.998,288.339,139.998z M288.341,430H34.068    c-1.58,0-2.865-1.285-2.865-2.864V172.863c0-1.58,1.285-2.865,2.865-2.865h254.272c1.58,0,2.865,1.285,2.865,2.865v254.273h0.001 C291.206,428.715,289.92,430,288.341,430z"></path></g></svg></span></div></div>
<pre id="pre448830" style="margin-top:0;" class="lang-cplusplus notranslate" data-language="c++" data-allowshrink="True" data-collapse="False" data-codeblock-processed="true"><span class="code-keyword">class</span> ConveyorThreadWrapperDemo : <span class="code-keyword">public</span> ConveyorThreadWrapper<span class="code-keyword">&lt;</span><span class="code-keyword">int</span><span class="code-keyword">&gt;</span> {
    <span class="code-keyword">enum</span> <span class="code-keyword">class</span> command {
        quit = <span class="code-string">'</span><span class="code-string">q'</span>, <span class="code-comment">// entire thread
</span>        abort = <span class="code-string">'</span><span class="code-string">a'</span>, <span class="code-comment">// current task
</span>        sleep = <span class="code-string">'</span><span class="code-string">s'</span>,
        wakeUp = <span class="code-string">'</span><span class="code-string">w'</span>,
    };
    <span class="code-keyword">static</span> <span class="code-keyword">const</span> <span class="code-keyword">char</span>* help() { <span class="code-keyword">return</span> <span class="code-string">"</span><span class="code-string">a: task abort, q: quit, s: sleep, w: wake up, key: "</span>; }
    <span class="code-keyword">static</span> <span class="code-keyword">bool</span> commandIs(<span class="code-keyword">char</span> c, command cmd) { <span class="code-keyword">return</span> (<span class="code-keyword">int</span>)cmd == (<span class="code-keyword">int</span>)c; }
public:
    <span class="code-keyword">using</span> natural = <span class="code-keyword">unsigned</span> <span class="code-keyword">long</span> <span class="code-keyword">long</span> <span class="code-keyword">int</span>;
    <span class="code-keyword">static</span> <span class="code-keyword">void</span> Run(natural delayMs) {
        natural max = <span class="code-digit">100</span>;
        IntegerConveyor cv;
        cv.CurrentTaskAborted = [](<span class="code-keyword">int</span>) -<span class="code-keyword">&gt;</span> <span class="code-keyword">void</span> {
            <span class="code-sdkkeyword">std::cout</span> <span class="code-keyword">&lt;</span><span class="code-keyword">&lt;</span> <span class="code-string">"</span><span class="code-string">. Enter any character: "</span>;
        }; <span class="code-comment">//cv.CurrentTaskAborted
</span>        <span class="code-keyword">using</span> cType = <span class="code-keyword">decltype</span>(cv);
        <span class="code-keyword">auto</span> sleep = [delayMs] {
            std::this_thread::sleep_for(std::chrono::milliseconds(delayMs));
        }; <span class="code-comment">//sleep
</span>        <span class="code-keyword">auto</span> Hailstone = [] (natural a) -<span class="code-keyword">&gt;</span> natural {
            <span class="code-keyword">if</span> (a % <span class="code-digit">2</span> == <span class="code-digit">0</span>)
                <span class="code-keyword">return</span> a / <span class="code-digit">2</span>;
            <span class="code-keyword">else</span>
                <span class="code-keyword">return</span> <span class="code-digit">3</span> * a + <span class="code-digit">1</span>;
        }; <span class="code-comment">//Hailstone (iteration)
</span>        <span class="code-keyword">auto</span> HailstoneStoppingTime = [Hailstone] (natural n) -<span class="code-keyword">&gt;</span> natural {
            natural stoppingTime = <span class="code-digit">0</span>;
            <span class="code-keyword">while</span> (n != <span class="code-digit">1</span>) {
                n = Hailstone(n);
                ++stoppingTime;
            } <span class="code-comment">//loop
</span>            <span class="code-keyword">return</span> stoppingTime;
        }; <span class="code-comment">//HailstoneStoppingTime
</span>        <span class="code-keyword">auto</span> lambdaHailstone = [HailstoneStoppingTime, sleep, max] (cType::SyncDelegate&amp; sync, <span class="code-keyword">int</span> <span class="code-keyword">value</span>) {
            <span class="code-keyword">for</span> (natural count = <span class="code-digit">1</span>; count <span class="code-keyword">&lt;</span> max; ++count) {
                natural stoppingTime = HailstoneStoppingTime(count + <span class="code-keyword">value</span>);
                sync(<span class="code-keyword">false</span>);
                <span class="code-sdkkeyword">std::cout</span>
                    <span class="code-keyword">&lt;</span><span class="code-keyword">&lt;</span> count <span class="code-keyword">&lt;</span><span class="code-keyword">&lt;</span> <span class="code-string">"</span><span class="code-string">: "</span> <span class="code-keyword">&lt;</span><span class="code-keyword">&lt;</span> help()
                    <span class="code-keyword">&lt;</span><span class="code-keyword">&lt;</span> <span class="code-keyword">value</span> <span class="code-keyword">&lt;</span><span class="code-keyword">&lt;</span> <span class="code-string">"</span><span class="code-string"> =&gt; Hailstone "</span> <span class="code-keyword">&lt;</span><span class="code-keyword">&lt;</span> stoppingTime <span class="code-keyword">&lt;</span><span class="code-keyword">&lt;</span> <span class="code-sdkkeyword">std::endl</span>;
                sleep();
            } <span class="code-comment">//loop
</span>        }; <span class="code-comment">//lambdaHailstone
</span>        natural mod = <span class="code-digit">1</span>;
        mod = mod <span class="code-keyword">&lt;</span><span class="code-keyword">&lt;</span> <span class="code-digit">32</span>; <span class="code-comment">// NOT 1 &lt; 32 !!!
</span>        natural multiplier = <span class="code-digit">1664525</span>; <span class="code-comment">// Numerical Recipes
</span>        natural increment = <span class="code-digit">1013904223</span>; <span class="code-comment">// Numerical Recipes
</span>        <span class="code-keyword">auto</span> Lgc = [mod, multiplier, increment](natural n) -<span class="code-keyword">&gt;</span> natural {
            <span class="code-keyword">return</span> (n * multiplier + increment) % mod;
        }; <span class="code-comment">//Lgc
</span>        <span class="code-keyword">auto</span> lambdaLgc = [Lgc, sleep, max](cType::SyncDelegate&amp; sync, <span class="code-keyword">int</span> <span class="code-keyword">value</span>) {
            natural n = <span class="code-keyword">value</span>;
            <span class="code-keyword">for</span> (natural count = <span class="code-digit">0</span>; count <span class="code-keyword">&lt;</span> max; count++) {
                n = Lgc(n);
                sync(<span class="code-keyword">false</span>);
                <span class="code-sdkkeyword">std::cout</span>
                    <span class="code-keyword">&lt;</span><span class="code-keyword">&lt;</span> help()
                    <span class="code-keyword">&lt;</span><span class="code-keyword">&lt;</span> <span class="code-keyword">value</span> <span class="code-keyword">&lt;</span><span class="code-keyword">&lt;</span> <span class="code-string">"</span><span class="code-string"> =&gt; LGC "</span> <span class="code-keyword">&lt;</span><span class="code-keyword">&lt;</span> (n) <span class="code-keyword">&lt;</span><span class="code-keyword">&lt;</span> <span class="code-sdkkeyword">std::endl</span>;
                sleep();
            } <span class="code-comment">//loop
</span>        }; <span class="code-comment">//lambdaLgc
</span>        SA::delegate<span class="code-keyword">&lt;</span><span class="code-keyword">void</span>(cType::SyncDelegate&amp;, <span class="code-keyword">int</span>)<span class="code-keyword">&gt;</span> delHailstone = lambdaHailstone;
        SA::delegate<span class="code-keyword">&lt;</span><span class="code-keyword">void</span>(cType::SyncDelegate&amp;, <span class="code-keyword">int</span>)<span class="code-keyword">&gt;</span> delLgc = lambdaLgc;
        cv.Start();
        <span class="code-keyword">char</span> cmd;
        <span class="code-keyword">while</span> (<span class="code-keyword">true</span>) {
            <span class="code-sdkkeyword">std::cin</span> <span class="code-keyword">&gt;</span><span class="code-keyword">&gt;</span> cmd;
            <span class="code-keyword">if</span> (commandIs(cmd, command::abort))
                cv.Abort();
            <span class="code-keyword">else</span> <span class="code-keyword">if</span> (commandIs(cmd, command::quit)) {
                cv.Abort(cType::AbortDepth::entierThread);
                <span class="code-keyword">break</span>;
            } <span class="code-keyword">else</span> <span class="code-keyword">if</span> (commandIs(cmd, command::sleep))
                cv.PutToSleep();
            <span class="code-keyword">else</span> <span class="code-keyword">if</span> (commandIs(cmd, command::wakeUp))
                cv.WakeUp();
            <span class="code-keyword">else</span> {
                <span class="code-keyword">int</span> cmdValue = (<span class="code-keyword">int</span>)cmd;
                <span class="code-keyword">if</span> (cmdValue % <span class="code-digit">2</span> == <span class="code-digit">0</span>)
                    cv.Enqueue(delHailstone, cmdValue);
                <span class="code-keyword">else</span>
                    cv.Enqueue(delLgc, cmdValue);
            } <span class="code-comment">//if
</span>        } <span class="code-comment">//loop
</span>        cv.Join();
    } <span class="code-comment">//Run
</span>}; <span class="code-comment">//class ConveyorThreadWrapperDemo</span></pre>

<p>This demo shows the use of <em>lambda expressions</em> which are extremely convenient for the case. Alternatively, the mechanism of delegates also allows for the use of static functions and constant or non-constant <em>instance functions</em>, as it is explained in the <a href="https://www.codeproject.com/Articles/1170503/The-Impossibly-Fast-Cplusplus-Delegates-Fixed">article on delegates</a>.</p>

<p>By the way, note a pretty obvious but important lambda expression technique: passing some objects through <a href="https://en.wikipedia.org/wiki/Closure_(computer_programming)">closure</a> and not through the parameter list. For example, the lambda expression <code>sleep</code> uses the value <code>delayMs</code> from the parameter of the method <code>Run</code> as <code>auto sleep = [delayMs]</code>.</p>

<p>For this application, this is essential. It could be passed in a parameter list, but let’s see how <code>sleep</code> is used. Ultimately, all those lambda expressions are called by the lambda expressions <code>lambdaHailstone</code> and <code>lambdaLgc</code> and also are passed through their closures. These two ultimate lambda expressions are never called in this context. Instead, they are assigned to the delegate instances. Their parameter lists should fit the profile of the delegate (shown <a href="#delegateTypes">here</a>) and cannot accept other actual parameters.</p>

<p>Pay attention that multiple characters can be entered sequentially while some task is being executed. It demonstrates the cases when new tasks are queued while one of the tasks is being executed. If, say, N tasks were queued during execution of another tasks, it will take up to N+1 current task aborts to bring the thread to a wait state. When the presently executing task is aborted, the next task is taken for execution from the queue.</p>

<p>If <em>shallow abort</em> is not performed for a while, the current task eventual completes execution. It puts the thread to sleep. The thread can be woken up by adding another task to the queue. I intentionally specified small number of iterations, to demonstrate this condition. There is no a need to add another virtual function or a delegate to hook up this event by the user code, because the appropriate action, if needed, can be simple written as a part of the task delegate code.</p>

<p>In this code sample, I tried to shorten the text at the expense of purely mathematical algorithms and leave the “system” aspects. At the same time, the fun part is about those algorithms.</p>

<h2 id="demonstrated-algorithms">Demonstrated Algorithms</h2>

<p>Let’s make a short fun break not really related to the topic of this article. In the demo application, to demonstrate passing different delegates to the queue, I’ve implemented the choice between the two (the chosen algorithm depends on the parity of the code point of the user-entered character): calculation of the total stopping time of a <a href="https://en.wikipedia.org/wiki/Collatz_conjecture">sequence of Hailstone numbers</a> and <a href="https://en.wikipedia.org/wiki/Linear_congruential_generator">linear congruential generator</a>.</p>

<p>First thing is a very intricate mathematical problem, most likely, not solved at the moment of writing; the problem is considered as an “extraordinarily difficult problem, out of reach of the present day mathematics”. The problem is called Collatz conjecture, or <code>3n+1</code> conjecture. It says that repeated sequence of numbers defined by the recursive process <code>n-&gt;n/2</code> for even <code>n</code> and <code>n-&gt;3n+1</code> for odd <code>n</code> will eventually reach the value of 1 for any initial <code>n</code>. So far, we don’t know numbers which <em>don’t</em> behave this way, but it’s not proven that such numbers don’t exit. In my demo, I calculate the Hailstone number sequences themselves, but display only the numbers of iterations required to achieve 1, which is called <em>total stopping time</em> for a given initial number <code>n</code>. For initial <code>n</code>, I take the sum of the code point of the user-entered character and the number of iteration of an outer cycle. This total stopping time value and its dependency on the initial number is one of the real mathematical wonders — do read <a href="https://en.wikipedia.org/wiki/Collatz_conjecture">the article</a>; it is very interesting.</p>

<p>The second algorithm is a very simple algorithm for generation of a deterministic sequence of pseudo-randomized numbers: <a href="https://en.wikipedia.org/wiki/Linear_congruential_generator">linear congruential generator</a>. The algorithm requires three carefully chosen numeric parameters, which I take according to <a href="https://en.wikipedia.org/wiki/Numerical_Recipes">Numerical Recipes</a>.</p>

<p>The implementations of these algorithms are way too trivial to show them here; everyone is welcome to look at them at in the downloadable source code.</p>

<h2 id="giving-the-wrapper-a-task">Giving the Wrapper a Task</h2>

<p>This is how a task can be queued:</p>

<div id="enqueue">
<div class="pre-lang" id="premain922777"><div>C++</div><div class="pre-action-link"><span id="copycode922777" class="copy-code" data-index="922777" style="visibility: visible;"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" viewBox="0 0 460 460" style="width: 16px;height:16px;" xml:space="preserve"><g><path d="M425.934,0H171.662c-18.122,0-32.864,14.743-32.864,32.864v77.134h30V32.864c0-1.579,1.285-2.864,2.864-2.864h254.272     c1.579,0,2.864,1.285,2.864,2.864v254.272c0,1.58-1.285,2.865-2.864,2.865h-74.729v30h74.729 c18.121,0,32.864-14.743,32.864-32.865V32.864C458.797,14.743,444.055,0,425.934,0z"></path><path d="M288.339,139.998H34.068c-18.122,0-32.865,14.743-32.865,32.865v254.272C1.204,445.257,15.946,460,34.068,460h254.272 c18.122,0,32.865-14.743,32.865-32.864V172.863C321.206,154.741,306.461,139.998,288.339,139.998z M288.341,430H34.068    c-1.58,0-2.865-1.285-2.865-2.864V172.863c0-1.58,1.285-2.865,2.865-2.865h254.272c1.58,0,2.865,1.285,2.865,2.865v254.273h0.001 C291.206,428.715,289.92,430,288.341,430z"></path></g></svg></span></div></div>
<pre id="pre922777" style="margin-top:0;" class="lang-cplusplus notranslate" data-language="c++" data-allowshrink="True" data-collapse="False" data-codeblock-processed="true"><span class="code-keyword">template</span><span class="code-keyword">&lt;</span><span class="code-keyword">typename</span> PARAM<span class="code-keyword">&gt;</span>
<span class="code-keyword">class</span> ConveyorThreadWrapper : <span class="code-keyword">public</span> ThreadWrapper {
public:
    
    <span class="code-comment">// ...
</span>
    <span class="code-keyword">void</span> Enqueue(TaskDelegate&amp; task, PARAM argument) {
        <span class="code-sdkkeyword">std::lock_guard</span><span class="code-keyword">&lt;</span><span class="code-sdkkeyword">std::mutex</span><span class="code-keyword">&gt;</span> lock(queueMutex);
        queue.push(<span class="code-keyword">new</span> QueueItem(task, argument));
        queueCondition.notify_one();
    } <span class="code-comment">//Enqueue
</span>
    <span class="code-comment">// ...
</span>
}; <span class="code-comment">//class ConveyorThreadWrapper</span></pre>

<p>The thread is notified on the new task. This is important if the queue is currently empty, so the thread is in the wait state and needs to be woken up. Let’s look at the queue synchronization.</p>

<h2 id="queue-synchronization">Queue Synchronization</h2>

<p>The elements stored in the queue are of the type <code>QueueItem</code> holding both pointers to the delegate instances and the values of the parameters needed for the call. The synchronization primitives <code>queueMutex</code> and <code>queueCondition</code> are used to synchronize operation of the function <code>Enqueue</code> shown <a href="#enqueue">above</a> and the thread running the task:</p>

<div id="getTask">
<div class="pre-lang" id="premain644154"><div>C++</div><div class="pre-action-link"><span class="code-collapse" data-index="644154" id="preShrink644154">Shrink ▲</span> &nbsp; <span id="copycode644154" class="copy-code" data-index="644154" style="visibility: visible;"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" viewBox="0 0 460 460" style="width: 16px;height:16px;" xml:space="preserve"><g><path d="M425.934,0H171.662c-18.122,0-32.864,14.743-32.864,32.864v77.134h30V32.864c0-1.579,1.285-2.864,2.864-2.864h254.272     c1.579,0,2.864,1.285,2.864,2.864v254.272c0,1.58-1.285,2.865-2.864,2.865h-74.729v30h74.729 c18.121,0,32.864-14.743,32.864-32.865V32.864C458.797,14.743,444.055,0,425.934,0z"></path><path d="M288.339,139.998H34.068c-18.122,0-32.865,14.743-32.865,32.865v254.272C1.204,445.257,15.946,460,34.068,460h254.272 c18.122,0,32.865-14.743,32.865-32.864V172.863C321.206,154.741,306.461,139.998,288.339,139.998z M288.341,430H34.068    c-1.58,0-2.865-1.285-2.865-2.864V172.863c0-1.58,1.285-2.865,2.865-2.865h254.272c1.58,0,2.865,1.285,2.865,2.865v254.273h0.001 C291.206,428.715,289.92,430,288.341,430z"></path></g></svg></span></div></div>
<pre id="pre644154" style="margin-top:0;" class="lang-cplusplus notranslate" data-language="c++" data-allowshrink="True" data-collapse="False" data-codeblock-processed="true"><span class="code-keyword">template</span><span class="code-keyword">&lt;</span><span class="code-keyword">typename</span> PARAM<span class="code-keyword">&gt;</span>
<span class="code-keyword">class</span> ConveyorThreadWrapper : <span class="code-keyword">public</span> ThreadWrapper {
<span class="code-comment">// ...
</span>private:

    <span class="code-comment">// ...
</span>
    <span class="code-keyword">struct</span> QueueItem {
        QueueItem() = <span class="code-keyword">default</span>;
        QueueItem(TaskDelegate&amp; del, PARAM param) {
            <span class="code-keyword">delegate</span> = &amp;del;
            parameter = param;
        } <span class="code-comment">//QueueItem
</span>        TaskDelegate* <span class="code-keyword">delegate</span>;
        PARAM parameter;
    }; <span class="code-comment">//struct QueueItem
</span>
    <span class="code-sdkkeyword">std::queue</span><span class="code-keyword">&lt;</span>QueueItem*<span class="code-keyword">&gt;</span> queue; <span class="code-comment">// protected by queueState and queueMutex
</span>    <span class="code-sdkkeyword">std::mutex</span> queueMutex;
    <span class="code-sdkkeyword">std::condition_variable</span> queueCondition;

    <span class="code-keyword">void</span> getTask(QueueItem&amp; itemCopy) {
        <span class="code-sdkkeyword">std::unique_lock</span><span class="code-keyword">&lt;</span><span class="code-sdkkeyword">std::mutex</span><span class="code-keyword">&gt;</span> ul(queueMutex);
        queueCondition.wait(ul, [=] {
            <span class="code-keyword">return</span> queue.size() <span class="code-keyword">&gt;</span> <span class="code-digit">0</span>;
        });
        <span class="code-keyword">auto</span> front = queue.front();
        itemCopy.<span class="code-keyword">delegate</span> = front-<span class="code-keyword">&gt;</span><span class="code-keyword">delegate</span>;
        itemCopy.parameter = front-<span class="code-keyword">&gt;</span>parameter;
        queue.pop();
        <span class="code-keyword">delete</span> front;
    } <span class="code-comment">//getTask
</span>}; <span class="code-comment">//class ConveyorThreadWrapper</span></pre>

<p>In addition to that, we need to keep the task responsive to <em>task throttling</em> (described in detail in the <a href="https://www.codeproject.com/Articles/1177478/Thread-Wrapper-CPP">previous article</a>) and abortion.</p>

<h2 id="thread-state-synchronization">Thread State Synchronization</h2>

<p>In the class <code>ThreadWrapper</code>, the function <code>SyncPoint</code> was immediately accessible to the thread code as a protected member function. In the delegate approach, this function is not accessible. Instead, a delegate instance based on this function is passed to each task delegate call. The class <code>ThreadWrapper</code> provides a static function which can be used by derived classes to create such delegate instance.</p>

<div id="initializeSyncPointDelegate">
<div class="pre-lang" id="premain496966"><div>C++</div><div class="pre-action-link"><span id="copycode496966" class="copy-code" data-index="496966" style="visibility: visible;"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" viewBox="0 0 460 460" style="width: 16px;height:16px;" xml:space="preserve"><g><path d="M425.934,0H171.662c-18.122,0-32.864,14.743-32.864,32.864v77.134h30V32.864c0-1.579,1.285-2.864,2.864-2.864h254.272     c1.579,0,2.864,1.285,2.864,2.864v254.272c0,1.58-1.285,2.865-2.864,2.865h-74.729v30h74.729 c18.121,0,32.864-14.743,32.864-32.865V32.864C458.797,14.743,444.055,0,425.934,0z"></path><path d="M288.339,139.998H34.068c-18.122,0-32.865,14.743-32.865,32.865v254.272C1.204,445.257,15.946,460,34.068,460h254.272 c18.122,0,32.865-14.743,32.865-32.864V172.863C321.206,154.741,306.461,139.998,288.339,139.998z M288.341,430H34.068    c-1.58,0-2.865-1.285-2.865-2.864V172.863c0-1.58,1.285-2.865,2.865-2.865h254.272c1.58,0,2.865,1.285,2.865,2.865v254.273h0.001 C291.206,428.715,289.92,430,288.341,430z"></path></g></svg></span></div></div>
<pre id="pre496966" style="margin-top:0;" class="lang-cplusplus notranslate" data-language="c++" data-allowshrink="True" data-collapse="False" data-codeblock-processed="true"><span class="code-keyword">class</span> ThreadWrapper {
<span class="code-comment">// ...
</span>protected:

    <span class="code-comment">// ...
</span>
    <span class="code-keyword">static</span> <span class="code-keyword">void</span> InitializeSyncPointDelegate(SA::delegate<span class="code-keyword">&lt;</span><span class="code-keyword">void</span>(<span class="code-keyword">bool</span>)<span class="code-keyword">&gt;</span>&amp; del, ThreadWrapper* instance) {
        del = SA::delegate<span class="code-keyword">&lt;</span><span class="code-keyword">void</span>(<span class="code-keyword">bool</span>)<span class="code-keyword">&gt;</span>::create<span class="code-keyword">&lt;</span>ThreadWrapper, &amp;ThreadWrapper::SyncPoint<span class="code-keyword">&gt;</span>(instance);
    } <span class="code-comment">//InitializeSyncPointDelegate
</span>
    <span class="code-comment">// ...
</span>
}; <span class="code-comment">//class ThreadWrapper</span></pre>

<p>To see how the task delegates are called, we need to look at the overridden function <a href="#shallowAbort"><code>Body</code></a>. Also, we can see how shallow abort is handled.</p>

<h2 id="handling-shallow-abort">Handling Shallow Abort</h2>

<p>Let’s take a look at the overridden method <code>Body</code>:</p>

<div id="shallowAbort">
<div class="pre-lang" id="premain578292"><div>C++</div><div class="pre-action-link"><span id="copycode578292" class="copy-code" data-index="578292" style="visibility: visible;"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" viewBox="0 0 460 460" style="width: 16px;height:16px;" xml:space="preserve"><g><path d="M425.934,0H171.662c-18.122,0-32.864,14.743-32.864,32.864v77.134h30V32.864c0-1.579,1.285-2.864,2.864-2.864h254.272     c1.579,0,2.864,1.285,2.864,2.864v254.272c0,1.58-1.285,2.865-2.864,2.865h-74.729v30h74.729 c18.121,0,32.864-14.743,32.864-32.865V32.864C458.797,14.743,444.055,0,425.934,0z"></path><path d="M288.339,139.998H34.068c-18.122,0-32.865,14.743-32.865,32.865v254.272C1.204,445.257,15.946,460,34.068,460h254.272 c18.122,0,32.865-14.743,32.865-32.864V172.863C321.206,154.741,306.461,139.998,288.339,139.998z M288.341,430H34.068    c-1.58,0-2.865-1.285-2.865-2.864V172.863c0-1.58,1.285-2.865,2.865-2.865h254.272c1.58,0,2.865,1.285,2.865,2.865v254.273h0.001 C291.206,428.715,289.92,430,288.341,430z"></path></g></svg></span></div></div>
<pre id="pre578292" style="margin-top:0;" class="lang-cplusplus notranslate" data-language="c++" data-allowshrink="True" data-collapse="False" data-codeblock-processed="true"><span class="code-keyword">class</span> ThreadWrapper {
<span class="code-comment">// ...
</span>protected:

    <span class="code-keyword">void</span> Body() <span class="code-keyword">override</span> <span class="code-keyword">final</span> {
        <span class="code-keyword">while</span> (<span class="code-keyword">true</span>) {
            QueueItem task;
            getTask(task);
            <span class="code-keyword">try</span> {
                (*task.<span class="code-keyword">delegate</span>)(syncDelegate, task.parameter);
            } <span class="code-keyword">catch</span> (ShallowThreadAbortException&amp;) {
                SetAbort(<span class="code-keyword">false</span>);
                OnCurrentTaskAborted(task.parameter);
            } <span class="code-comment">//exception
</span>        } <span class="code-comment">//loop
</span>    } <span class="code-comment">//Body
</span>
    <span class="code-comment">// ...
</span>
}; <span class="code-comment">//class ThreadWrapper</span></pre>

<p>This code samples shows how the task delegates are called. Also, let’s look at the <code>ShallowAbortException</code> handling. First of all, note that the abort condition is cleared. It is needed for the next task to execute immediately, as soon as a new element is queued. The abort condition is set/cleared in the base class <code>ThreadWrapper</code>, with synchronization. This is shown in the <a href="https://www.codeproject.com/Articles/1177478/Thread-Wrapper-CPP#abort">previous article</a>.</p>

<p>Remember, all other exceptions, including the <em>regular</em> “<em>deep</em>” <code>ThreadAbortException</code> are handled in the outer context of <code>Body</code>. This is explained in detail in the <a href="https://www.codeproject.com/Articles/1177478/Thread-Wrapper-CPP#exceptions">previous article</a>.</p>

<p>This is how the user can choose between <em>shallow</em> and <em>deep</em> abort:</p>

<div id="abort">
<div class="pre-lang" id="premain218982"><div>C++</div><div class="pre-action-link"><span id="copycode218982" class="copy-code" data-index="218982" style="visibility: visible;"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" viewBox="0 0 460 460" style="width: 16px;height:16px;" xml:space="preserve"><g><path d="M425.934,0H171.662c-18.122,0-32.864,14.743-32.864,32.864v77.134h30V32.864c0-1.579,1.285-2.864,2.864-2.864h254.272     c1.579,0,2.864,1.285,2.864,2.864v254.272c0,1.58-1.285,2.865-2.864,2.865h-74.729v30h74.729 c18.121,0,32.864-14.743,32.864-32.865V32.864C458.797,14.743,444.055,0,425.934,0z"></path><path d="M288.339,139.998H34.068c-18.122,0-32.865,14.743-32.865,32.865v254.272C1.204,445.257,15.946,460,34.068,460h254.272 c18.122,0,32.865-14.743,32.865-32.864V172.863C321.206,154.741,306.461,139.998,288.339,139.998z M288.341,430H34.068    c-1.58,0-2.865-1.285-2.865-2.864V172.863c0-1.58,1.285-2.865,2.865-2.865h254.272c1.58,0,2.865,1.285,2.865,2.865v254.273h0.001 C291.206,428.715,289.92,430,288.341,430z"></path></g></svg></span></div></div>
<pre id="pre218982" style="margin-top:0;" class="lang-cplusplus notranslate" data-language="c++" data-allowshrink="True" data-collapse="False" data-codeblock-processed="true"><span class="code-keyword">class</span> ThreadWrapper {
public:

    <span class="code-comment">// ...
</span>
    <span class="code-keyword">enum</span> <span class="code-keyword">class</span> AbortDepth { currentTask, entierThread, };
    <span class="code-keyword">void</span> Abort(AbortDepth depth = AbortDepth::currentTask) {
        SetAbort(<span class="code-keyword">true</span>, depth == AbortDepth::currentTask);
    } <span class="code-comment">//Abort
</span>
    <span class="code-comment">// ...
</span>
}; <span class="code-comment">//class ThreadWrapper</span></pre>

<h2 id="delegate-and-delegate-parameter-types">Delegate and Delegate Parameter Types</h2>

<p>This is how the involved delegate types are defined:</p>

<div id="delegateTypes">
<div class="pre-lang" id="premain249732"><div>C++</div><div class="pre-action-link"><span id="copycode249732" class="copy-code" data-index="249732" style="visibility: visible;"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" viewBox="0 0 460 460" style="width: 16px;height:16px;" xml:space="preserve"><g><path d="M425.934,0H171.662c-18.122,0-32.864,14.743-32.864,32.864v77.134h30V32.864c0-1.579,1.285-2.864,2.864-2.864h254.272     c1.579,0,2.864,1.285,2.864,2.864v254.272c0,1.58-1.285,2.865-2.864,2.865h-74.729v30h74.729 c18.121,0,32.864-14.743,32.864-32.865V32.864C458.797,14.743,444.055,0,425.934,0z"></path><path d="M288.339,139.998H34.068c-18.122,0-32.865,14.743-32.865,32.865v254.272C1.204,445.257,15.946,460,34.068,460h254.272 c18.122,0,32.865-14.743,32.865-32.864V172.863C321.206,154.741,306.461,139.998,288.339,139.998z M288.341,430H34.068    c-1.58,0-2.865-1.285-2.865-2.864V172.863c0-1.58,1.285-2.865,2.865-2.865h254.272c1.58,0,2.865,1.285,2.865,2.865v254.273h0.001 C291.206,428.715,289.92,430,288.341,430z"></path></g></svg></span></div></div>
<pre id="pre249732" style="margin-top:0;" class="lang-cplusplus notranslate" data-language="c++" data-allowshrink="True" data-collapse="False" data-codeblock-processed="true"><span class="code-keyword">using</span> SyncDelegate = SA::delegate<span class="code-keyword">&lt;</span><span class="code-keyword">void</span>(<span class="code-keyword">bool</span>)<span class="code-keyword">&gt;</span>;
<span class="code-keyword">using</span> TaskDelegate = SA::delegate<span class="code-keyword">&lt;</span><span class="code-keyword">void</span>(SyncDelegate&amp;, PARAM)<span class="code-keyword">&gt;</span>;</pre>

<p>The delegate type <code>TaskDelegate</code> is used to be stored in the queue, and the <code>TaskDelegate</code> reflects the profile of <code>SyncPoint</code>. The delegate instance based on <code>SyncPoint</code> is passed as a first parameter to the task function to give the application developer the opportunity of keeping the task responsive to thread throttling and aborts. Note that the implementation of delegates doesn’t have to be implemented in a class derived from the thread wrapper class but can be implemented in a user’s class, where it has no access to the <code>SyncPoint</code> function itself.</p>

<p>As it is explained in my <a href="https://www.codeproject.com/Articles/1170503/The-Impossibly-Fast-Cplusplus-Delegates-Fixed">article on delegates</a>, a delegate instance can be constructed out of a static function, instance function, constant instance function or a <em>lambda expression</em>. The closure capture is also supported, which is a very delicate issue (for example, passing an instance of a lambda expression breaks the capture).</p>

<p>The user of the class is responsible for the memory management for delegate instances. First of all, the delegates should be called in the scope of the lambda expression used. The C++ standard explicitly specifies that captured context is not preserved out of the scope of the lambda expression declaration.</p>

<p>The <code>PARAM</code> value is passed by value and stored in the wrapper queue. It seems to be reasonable. The whole idea of the queue is to keep all what’s needed for the delegate calls. At the same time, not all parameter types are suitable for a <code>ConveyorThreadWrapper</code> template parameter. It’s not so easy to list all requirements, but the potential problems can be easily identified during application development. Apparently, the default constructor should not be deleted, the types should support copy by value operators, and so on. In particular, if the parameter structure has direct or indirect pointers, it should be the responsibility of the application developer to make sure that those pointers point to valid memory objects during the delegate call. Another issue with those pointers is this: if they can be used in the thread of the wrapper, they and the pointed object should be the subject of thread synchronization. The application developer should take care of all such issues. One encapsulated synchronization mechanism suitable for many most typical cases is offered on the <a href="https://www.codeproject.com/Articles/1177478/Thread-Wrapper-CPP#interlocked-properties">previous article</a>.</p>

<h2 id="compatibility-and-build">Compatibility and Build</h2>

<p>All the thread wrappers solution is contained in just two files solution is contained in just two files:</p>

<ul style="list-style-type: none; list-style-image: initial">
	<li>“ThreadWrapper.h”,</li>	<li>“InterlockedProperty.h”,</li>	<li>“DelegateBase.h”,</li>	<li>“Delegate.h”,</li>	<li>“ConveyorThreadWrapper.h”,</li></ul>

<p>they can be added to any project.</p>

<p>The compiler should support <a href="https://en.wikipedia.org/wiki/C%2B%2B11">C++11</a> or later standard. For GCC, this is an option which should be set to <code>-std=c++11</code> or, say, <code>-std=c++14</code>.</p>

<p>The demo project is provided in two forms: 1) Visual Studio 2015 solution and project using Microsoft C++ compiler and <a href="http://clang.llvm.org/">Clang</a> — see “ThreadWrapper.sln” and 2) <a href="http://www.codeblocks.org/">Code::Blocks</a> project using <a href="https://gcc.gnu.org/">GCC</a> — “ ThreadWrapper.cbp”. For all other options, one can assemble a project or a make file by adding all “*.h” and “*.cpp” files in the code directory “Cpp”, a subdirectory of the directory of the solution file.</p>

<p>I tested the code with Visual Studio 2015, <a href="http://clang.llvm.org/">Clang</a> 4.0.0, <a href="https://gcc.gnu.org/">GCC</a> 5.1.0.</p>

<p>The C++ options included “disable language extensions” (<code>/Za</code> for Microsoft and Clang), which seems to be essential for Microsoft.</p>

<h2 id="versions">Versions</h2>

<h3 id="section">1.0</h3>

<p>Initial version, March 21, 2017</p>

<h3 id="section-1">2.0</h3>

<p>March 24, 2017</p>

<p>The class <code>ConveyorThreadWrapper</code> has been simplified through better reuse of the <code>ThreadWrapper</code> code, which also has been updated. Thread state synchronization was separated from queue synchronization, which is potentially better for the throughput. The demo code demonstrating both classes was re-designed. The previous article <a href="https://www.codeproject.com/Articles/1177869/Conveyor-Thread-Wrapper-CPP"><em>Conveyor Thread Wrapper for Modern C++</em></a> is updated.</p>

<h3>2.1</h3>
<p>October 29, 2017</p>

<p>Fixed a bug in <code>ThreadWrapper::ExceptionCaught</code> function signature. Must be:
<code>virtual void ExceptionCaught(std::exception&amp; exception) {}</code>.</p>

<h2 id="conclusions">Conclusions</h2>

<p>I really think that two thread wrapper types, <code>ThreadWrapper</code> and <code>ConveyorThreadWrapper</code> cover the programming models most important for most typical practical cases. Also, the can help to simplify and streamline thread programming in general. First of these two wrapper type, as less specialized, imposes no limitations on leveraging the full power of general C++ threading.</p>

<p>I will greatly appreciate all informative criticism, issue reports, notes and suggestions for improvements.</p>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>

<!-- Article Ends -->


						</div>
						

						
						<h2>License</h2>
						<div id="LicenseTerms"><p>This article, along with any associated source code and files, is licensed under <a href="http://www.codeproject.com/info/cpol10.aspx" rel="license">The Code Project Open License (CPOL)</a></p></div>
						

						
						<br>
						
						    <br>
						
						

						<div class="clearfix"></div>

						<div style="padding-top:8px">
							
						</div>

					

				    
					</form>

				</div>

				
				<div class="bottom-promo"> 
				    
				</div>
				
                
                

				
				
				

			</div>
			

            
            
            

        </div>
        

		
		<div class="site-footer">
			<div class="align-left">
				<a id="ctl00_PermaLink" href="https://www.codeproject.com/Articles/1177869/Conveyor-Thread-Wrapper-for-Modern-Cplusplus">Permalink</a><br>
				<br>
				<a id="ctl00_PrivacyLink" href="https://www.codeproject.com/info/privacy.aspx">Privacy</a><br>
    			<a id="ctl00_CookiePolicyLink" href="https://www.codeproject.com/info/cookie.aspx">Cookies</a><br>
                <a id="ctl00_TermsOfUseLink" href="https://www.codeproject.com/info/TermsOfUse.aspx">Terms of Use</a><br>
			</div>

            <div class="align-center">
				


<div class="page-width">
    Layout: <a id="ctl00_PageWidth_FixedT" title="Fixed width layout" rel="nofollow" class=" active" href="https://www.codeproject.com/Articles/1177869/Conveyor-Thread-Wrapper-CPP?PageFlow=FixedWidth">fixed</a>
    |
    <a id="ctl00_PageWidth_FluidT" title="Fluid layout" rel="nofollow" href="https://www.codeproject.com/Articles/1177869/Conveyor-Thread-Wrapper-CPP?PageFlow=Fluid">fluid</a>
</div>


				

				

	            

                <br>
			</div>
                
			<div class="align-right">
				Article Copyright 2017 by Sergey Alexandrovich Kryukov<br>Everything else
				Copyright © <a href="mailto:webmaster@codeproject.com">CodeProject</a>, 1999-2024<br>
                <br>
				Web01 
				2.8:2024-12-08:1<br>
			</div>
		</div>
		

		<br clear="all">
		
			

	</div> 
	</div> 
</div>







<script type="text/javascript"> // DEFERRED script

document.addEventListener('DOMContentLoaded', function() {

	new CodeBlocks().initialise('#contentdiv');
	
	$('.author-wrapper .description').shorten({showChars: 400});
	
	anchorAnimate();
	
	$('#__EVENTVALIDATION').attr('autocomplete', 'off');

})
</script>










<style type="text/css">.copied::after {  position: absolute;  right: 0;  display: inline-block; white-space: nowrap; content: 'copied'; color: #fff; background-color: #f90;  border-radius: 3px; padding:1px 8px; opacity: 0;  will-change: opacity, transform; animation: showcopied 1.5s ease; } @keyframes showcopied { 0% { opacity: 0; } 70% { opacity: 1; } 100% { opacity: 0; } } </style><canvas id="cv1" width="1px" height="1px" style="position:absolute;left:0;top:0;pointer-events:none"></canvas><canvas id="cv2" width="1px" height="1px" style="position:absolute;left:0;top:0;pointer-events:none"></canvas></body><grammarly-desktop-integration data-grammarly-shadow-root="true"><template shadowrootmode="open"><style>
      div.grammarly-desktop-integration {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
        -moz-user-select: none;
        -webkit-user-select: none;
        -ms-user-select:none;
        user-select:none;
      }

      div.grammarly-desktop-integration:before {
        content: attr(data-content);
      }
    </style><div aria-label="grammarly-integration" role="group" tabindex="-1" class="grammarly-desktop-integration" data-content="{&quot;mode&quot;:&quot;full&quot;,&quot;isActive&quot;:true,&quot;isUserDisabled&quot;:false}"></div></template></grammarly-desktop-integration></html>